<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TARGUI STORE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-blue: #0056D2;
            --primary-blue-dark: #0041A3;
            --primary-blue-light: #007BFF;
            --primary-white: #FFFFFF;
            --primary-black: #1C1C1C;
            --primary-gray: #F8F9FA;
            --secondary-gray: #6C757D;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --sidebar-width: 280px;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
            --accent-color: #6A11CB;
            --gradient-bg: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-color) 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #f5f7fb 0%, #eef2ff 100%);
            color: var(--primary-black);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* ===== SIDEBAR STYLÉE ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            transform: translateX(0);
        }
        
        .sidebar.closed {
            transform: translateX(calc(-1 * var(--sidebar-width)));
        }
        
        /* Zone de détection à gauche */
        .sidebar-trigger-zone {
            position: fixed;
            left: 0;
            top: 0;
            width: 20px;
            height: 100vh;
            z-index: 999;
            background: transparent;
            transition: background 0.3s ease;
        }
        
        .sidebar-trigger-zone:hover {
            background: rgba(0, 86, 210, 0.1);
        }
        
        .sidebar-trigger-zone.active {
            width: 50px;
        }

        .logo-section {
            padding: 2rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(255, 255, 255, 0.03);
        }

        .logo-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            border: 3px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .logo-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            background: linear-gradient(to right, #fff, #6A11CB);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logo-text:hover {
            transform: scale(1.05);
        }

        .logo-subtitle {
            opacity: 0.7;
            font-size: 0.8rem;
            font-weight: 400;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .nav-menu {
            padding: 1.5rem 0;
        }

        .nav-item {
            padding: 1rem 1.5rem;
            margin: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: rgba(255,255,255,0.7);
            transition: var(--transition);
            cursor: pointer;
            border-radius: var(--border-radius-sm);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(to bottom, var(--primary-blue), var(--accent-color));
            transform: translateX(-10px);
            transition: var(--transition);
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-item:hover::before {
            transform: translateX(0);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(106, 17, 203, 0.2) 0%, rgba(0, 86, 210, 0.2) 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-item.active::before {
            transform: translateX(0);
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        .nav-icon {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
            transition: var(--transition);
        }

        .nav-badge {
            background: linear-gradient(135deg, var(--danger-color), #ff6b6b);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: auto;
            box-shadow: 0 3px 8px rgba(220, 53, 69, 0.3);
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.05);
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.6;
        }

        /* ===== MENU TOGGLE ===== */
        .menu-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 1rem;
            left: calc(var(--sidebar-width) + 1rem);
            z-index: 1001;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-color));
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar.closed ~ .main-content .menu-toggle {
            left: 1rem;
        }

        .menu-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 86, 210, 0.4);
        }
        
        .menu-toggle i {
            transition: transform 0.3s ease;
        }
        
        .sidebar.closed ~ .main-content .menu-toggle i {
            transform: rotate(180deg);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
            min-height: 100vh;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar.closed ~ .main-content {
            margin-left: 0;
        }

        /* ===== HEADER STYLÉ ===== */
        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .page-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary-blue), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-title-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 5px 15px rgba(0, 86, 210, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 86, 210, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid rgba(0, 86, 210, 0.1);
            transition: var(--transition);
        }

        .user-info:hover {
            background: rgba(0, 86, 210, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 86, 210, 0.1);
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 5px 15px rgba(0, 86, 210, 0.3);
        }

        /* ===== STATS CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border-left: 5px solid var(--primary-blue);
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--primary-blue), var(--accent-color));
        }

        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.9rem;
            color: var(--secondary-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(0,86,210,0.1), rgba(106, 17, 203, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 86, 210, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-black);
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, var(--primary-blue), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .stat-change {
            font-size: 0.9rem;
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ===== HERO SECTION ===== */
        .hero-section {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-color) 100%);
            border-radius: var(--border-radius);
            padding: 4rem;
            margin-bottom: 2rem;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 86, 210, 0.3);
        }

        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 600px;
        }

        .hero-title {
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .hero-image {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 50%;
            background: url('https://i.postimg.cc/fTq2w6dP/unnamed.jpg') center/cover;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.2);
        }

        .hero-image::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, rgba(0, 86, 210, 0.9), transparent);
        }

        /* ===== PRODUCTS GRID ===== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .product-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .product-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-lg);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: var(--transition);
        }

        .product-card:hover .product-image {
            transform: scale(1.05);
        }

        .product-info {
            padding: 1.5rem;
        }

        .product-category {
            color: var(--secondary-gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .product-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-black);
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-blue);
            margin-bottom: 1rem;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-color));
            color: white;
            box-shadow: 0 5px 15px rgba(0, 86, 210, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 86, 210, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #20bf6b);
            color: white;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #ff9f1a);
            color: var(--primary-black);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #ff3838);
            color: white;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        /* ===== FORMS ===== */
        .form-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-black);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.8);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0,86,210,0.1);
            background: white;
        }

        /* ===== TABLES ===== */
        .data-table {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            margin-top: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 86, 210, 0.03);
        }

        .table-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-blue);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--secondary-gray);
            border-bottom: 1px solid #e9ecef;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* ===== TOAST ===== */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 400px;
            border-left: 5px solid var(--success-color);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-error {
            border-left-color: var(--danger-color);
        }

        .toast-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .toast-success .toast-icon {
            background: rgba(40,167,69,0.1);
            color: var(--success-color);
        }

        .toast-error .toast-icon {
            background: rgba(220,53,69,0.1);
            color: var(--danger-color);
        }

        /* ===== LOADER ===== */
        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            gap: 1rem;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 86, 210, 0.1);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) {
            .sidebar {
                transform: translateX(-100%);
                box-shadow: none;
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 5px 0 25px rgba(0, 0, 0, 0.1);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .hero-title {
                font-size: 2.2rem;
            }
            
            .hero-image {
                width: 40%;
            }
        }

        @media (max-width: 992px) {
            .main-content {
                padding: 1.5rem;
            }
            
            .hero-section {
                padding: 2.5rem;
            }
            
            .hero-title {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .hero-section {
                padding: 2rem;
            }
            
            .hero-title {
                font-size: 1.8rem;
            }
            
            .hero-image {
                display: none;
            }
            
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .user-info {
                align-self: flex-end;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 1rem;
            }
            
            .form-section {
                padding: 1.5rem;
            }
            
            .hero-section {
                padding: 1.5rem;
            }
            
            .hero-title {
                font-size: 1.5rem;
            }
            
            .hero-subtitle {
                font-size: 1rem;
            }
        }

        /* ===== UTILITY ===== */
        .hidden {
            display: none;
        }

        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mt-3 { margin-top: 1rem; }
        .mt-4 { margin-top: 1.5rem; }
        .d-flex { display: flex; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 1rem; }
        .w-100 { width: 100%; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge-success { background: var(--success-color); color: white; }
        .badge-warning { background: var(--warning-color); color: var(--primary-black); }
        .badge-danger { background: var(--danger-color); color: white; }
        .badge-info { background: var(--primary-blue); color: white; }
        
        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes logoSpin {
            0% {
                transform: rotate(0deg) scale(1);
            }
            50% {
                transform: rotate(360deg) scale(1.2);
            }
            100% {
                transform: rotate(720deg) scale(1);
            }
        }
        
        @keyframes crownFloat {
            0%, 100% {
                transform: translateY(0) rotate(-5deg);
            }
            50% {
                transform: translateY(-10px) rotate(5deg);
            }
        }
        
        @keyframes sparkle {
            0%, 100% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }
        }
        
        @keyframes textReveal {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.8);
                filter: blur(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }
        
        @keyframes glowPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.8), 0 0 80px rgba(255, 215, 0, 0.5);
            }
        }
        
        @keyframes particleFloat {
            0% {
                opacity: 0;
                transform: translateY(0) translateX(0) scale(0);
            }
            10% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) translateX(var(--tx)) scale(1);
            }
        }
        
        @keyframes slideInLeft {
            from { 
                opacity: 0; 
                transform: translateX(-50px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        @keyframes storeNamePulse {
            0%, 100% { 
                transform: scale(1);
                background-position: 0% 50%;
            }
            50% { 
                transform: scale(1.05);
                background-position: 100% 50%;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.2);
            }
        }
        
        @keyframes storeNameGlow {
            0%, 100% {
                text-shadow: 0 0 10px rgba(106, 17, 203, 0.5),
                            0 0 20px rgba(106, 17, 203, 0.3),
                            0 0 30px rgba(106, 17, 203, 0.2);
            }
            50% {
                text-shadow: 0 0 20px rgba(106, 17, 203, 0.8),
                            0 0 30px rgba(106, 17, 203, 0.6),
                            0 0 40px rgba(106, 17, 203, 0.4);
            }
        }
        
        .logo-text {
            animation: storeNameGlow 5s ease-in-out infinite;
            transition: all 0.3s ease;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .category-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-lg) !important;
        }
        
        .brand-badge:hover {
            transform: translateY(-3px);
            background: var(--primary-blue) !important;
            border-color: var(--primary-blue) !important;
        }
        
        .brand-badge:hover span {
            color: white !important;
        }
        
        .product-card:hover .product-image {
            transform: scale(1.1);
        }
        
        /* ===== PRÉVISUALISATION PRODUIT ===== */
        .product-preview-card {
            animation: fadeInUp 0.4s ease;
        }
        
        #previewPanel {
            transition: all 0.3s ease;
        }
        
        #previewPanel::-webkit-scrollbar {
            width: 6px;
        }
        
        #previewPanel::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 3px;
        }
        
        @media (max-width: 1200px) {
            #formPreviewContainer {
                grid-template-columns: 1fr !important;
            }
            
            #previewPanel {
                position: relative !important;
                top: 0 !important;
                max-height: none !important;
                margin-top: 2rem;
            }
        }
        
        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, var(--primary-blue), var(--accent-color));
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, var(--primary-blue-dark), #5a0cb3);
        }
    </style>
</head>
<body>
    <!-- MENU TOGGLE -->
    <button class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <div class="admin-container">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="logo-section" onclick="showLogoAnimation()" style="cursor: pointer;">
                <div class="logo-img">
                    <img src="https://i.postimg.cc/C5z8J6K1/image-2-logo.jpg" alt="TARGUI STORE Logo">
                </div>
                <div class="logo-text" id="storeNameLogo">TARGUI STORE</div>
                <div class="logo-subtitle">LE CLIENTS EST ROI </div>
            </div>
            
            <div class="nav-menu">
                <div class="nav-item active" data-page="dashboard">
                    <div class="nav-icon"><i class="fas fa-store"></i></div>
                    <span>Boutique</span>
                </div>
                
                <div class="nav-item" data-page="categories">
                    <div class="nav-icon"><i class="fas fa-th-large"></i></div>
                    <span>Catégories</span>
                </div>
                
                <div class="nav-item" data-page="cart">
                    <div class="nav-icon"><i class="fas fa-shopping-cart"></i></div>
                    <span>Mon Panier</span>
                    <span class="nav-badge" id="cartCount">0</span>
                </div>
                
                <div class="nav-item" data-page="add-product">
                    <div class="nav-icon"><i class="fas fa-plus-circle"></i></div>
                    <span>Ajouter un produit</span>
                </div>
                
                <div class="nav-item" data-page="customers">
                    <div class="nav-icon"><i class="fas fa-users"></i></div>
                    <span>Clients & Commandes</span>
                    <span class="nav-badge" id="customersCount">0</span>
                </div>
                
                <div class="nav-item" data-page="accounting">
                    <div class="nav-icon"><i class="fas fa-calculator"></i></div>
                    <span>Comptabilité</span>
                </div>
                
                <div class="nav-item" data-page="analytics">
                    <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                    <span>Analytiques</span>
                </div>
                
                <div class="nav-item" data-page="settings">
                    <div class="nav-icon"><i class="fas fa-cog"></i></div>
                    <span>Paramètres</span>
                </div>
            </div>
            
        </div>
        
        <!-- MAIN CONTENT -->
        <!-- Zone de détection à gauche pour ouvrir la sidebar -->
        <div class="sidebar-trigger-zone" id="sidebarTriggerZone" onmouseenter="openSidebarOnHover()"></div>
        
        <!-- Bouton toggle sidebar -->
        <button class="menu-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="Ouvrir/Fermer le menu">
            <i class="fas fa-bars" id="sidebarToggleIcon"></i>
        </button>
        
        <div class="main-content" id="mainContent">
            <!-- HEADER -->
            <div class="header">
                <div class="page-title">
                    <div class="page-title-icon" id="pageTitleIcon">
                        <i class="fas fa-store"></i>
                    </div>
                    <span id="pageTitle">Boutique</span>
                </div>
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-store"></i>
                    </div>
                    <div>
                        <div style="font-weight: 700;" id="storeNameHeader">TARGUI STORE</div>
                        <div style="font-size: 0.85rem; color: var(--secondary-gray);">Boutique en ligne</div>
                    </div>
                </div>
            </div>
            
            <!-- PAGE CONTENT -->
            <div id="pageContent" class="fade-in">
                <!-- Le contenu des pages sera chargé ici dynamiquement -->
            </div>
        </div>
    </div>
    
    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        // ===== CONFIGURATION SUPABASE =====
        const SUPABASE_URL = 'https://flfliuhisbjnsmqcdbrd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsZmxpdWhpc2JqbnNtcWNkYnJkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NDc3MjU2MiwiZXhwIjoyMDgwMzQ4NTYyfQ.1CizD0Pjb6co8zXKSzHmz1DS7XbMtHI_y8Qa89BuYe0';
        
        // Initialiser Supabase
        let supabase = null;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('✅ Connexion Supabase réussie');
        } catch (error) {
            console.error('❌ Erreur de connexion Supabase:', error);
        }
        
        // Mode de sauvegarde (true = Supabase, false = localStorage)
        const USE_SUPABASE = true; // Changez à false pour utiliser localStorage
        
        // ===== ÉTAT GLOBAL =====
        const state = {
            products: JSON.parse(localStorage.getItem('targui_products')) || [],
            orders: JSON.parse(localStorage.getItem('targui_orders')) || [],
            customers: JSON.parse(localStorage.getItem('targui_customers')) || [],
            promotions: JSON.parse(localStorage.getItem('targui_promotions')) || [],
            customCategories: JSON.parse(localStorage.getItem('targui_custom_categories')) || [],
            customBrands: JSON.parse(localStorage.getItem('targui_custom_brands')) || [],
            cart: JSON.parse(localStorage.getItem('targui_cart')) || [],
            favorites: JSON.parse(localStorage.getItem('targui_favorites')) || [],
            sales: JSON.parse(localStorage.getItem('targui_sales')) || [],
            barcodeScannerActive: false,
            settings: JSON.parse(localStorage.getItem('targui_settings')) || {
                whatsappNumber: "",
                currency: "FCFA",
                storeName: "",
                contactEmail: "",
                storeAddress: "",
                storeLocation: "",
                storeLogo: "",
                facebookUrl: "",
                instagramUrl: "",
                tiktokUrl: "",
                linkedinUrl: "",
                twitterUrl: ""
            },
            currentPage: 'dashboard',
            currentProduct: null,
            searchQuery: '',
            currentFilter: null
        };
        
        // ===== ICONES DES PAGES =====
        const pageIcons = {
            'dashboard': 'fa-store',
            'cart': 'fa-shopping-cart',
            'add-product': 'fa-plus-circle',
            'categories': 'fa-th-large',
            'customers': 'fa-users',
            'accounting': 'fa-calculator',
            'analytics': 'fa-chart-line',
            'settings': 'fa-cog'
        };
        
        // ===== INITIALISATION =====
        // ===== FONCTIONS SIDEBAR =====
        let sidebarState = {
            isOpen: true,
            hoverTimeout: null
        };
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const triggerZone = document.getElementById('sidebarTriggerZone');
            const toggleIcon = document.getElementById('sidebarToggleIcon');
            
            if (!sidebar) return;
            
            sidebarState.isOpen = !sidebarState.isOpen;
            
            if (sidebarState.isOpen) {
                sidebar.classList.remove('closed');
                if (triggerZone) triggerZone.style.width = '20px';
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-bars';
                }
            } else {
                sidebar.classList.add('closed');
                if (triggerZone) triggerZone.style.width = '20px';
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-chevron-right';
                }
            }
            
            // Sauvegarder l'état
            localStorage.setItem('sidebarState', JSON.stringify(sidebarState));
        }
        
        function openSidebarOnHover() {
            const sidebar = document.getElementById('sidebar');
            const triggerZone = document.getElementById('sidebarTriggerZone');
            
            if (!sidebar || sidebarState.isOpen) return;
            
            // Délai pour éviter les ouvertures accidentelles
            if (sidebarState.hoverTimeout) {
                clearTimeout(sidebarState.hoverTimeout);
            }
            
            sidebarState.hoverTimeout = setTimeout(() => {
                sidebar.classList.remove('closed');
                sidebarState.isOpen = true;
                if (triggerZone) triggerZone.style.width = '50px';
            }, 100);
        }
        
        function closeSidebarOnMouseLeave() {
            const sidebar = document.getElementById('sidebar');
            const triggerZone = document.getElementById('sidebarTriggerZone');
            
            if (!sidebar || !sidebarState.isOpen) return;
            
            if (sidebarState.hoverTimeout) {
                clearTimeout(sidebarState.hoverTimeout);
            }
            
            // Ne pas fermer automatiquement, seulement au clic
            // Cette fonction peut être utilisée pour d'autres interactions
        }
        
        function initSidebar() {
            // Restaurer l'état sauvegardé
            const savedState = localStorage.getItem('sidebarState');
            if (savedState) {
                try {
                    sidebarState = JSON.parse(savedState);
                } catch (e) {
                    sidebarState = { isOpen: true, hoverTimeout: null };
                }
            }
            
            const sidebar = document.getElementById('sidebar');
            const triggerZone = document.getElementById('sidebarTriggerZone');
            const toggleIcon = document.getElementById('sidebarToggleIcon');
            
            if (sidebar) {
                if (!sidebarState.isOpen) {
                    sidebar.classList.add('closed');
                    if (toggleIcon) {
                        toggleIcon.className = 'fas fa-chevron-right';
                    }
                } else {
                    if (toggleIcon) {
                        toggleIcon.className = 'fas fa-bars';
                    }
                }
            }
            
            // Détection de la souris à gauche de l'écran (zone de 30px)
            let mouseX = 0;
            let hoverTimeout = null;
            let isHovering = false;
            
            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                
                // Si la souris est dans les 30 premiers pixels à gauche et la sidebar est fermée
                if (mouseX <= 30 && !sidebarState.isOpen && !isHovering) {
                    if (hoverTimeout) clearTimeout(hoverTimeout);
                    
                    hoverTimeout = setTimeout(() => {
                        if (mouseX <= 30 && !sidebarState.isOpen) {
                            isHovering = true;
                            const sidebar = document.getElementById('sidebar');
                            if (sidebar) {
                                sidebar.classList.remove('closed');
                                sidebarState.isOpen = true;
                                localStorage.setItem('sidebarState', JSON.stringify(sidebarState));
                                
                                if (triggerZone) {
                                    triggerZone.style.width = '50px';
                                    triggerZone.style.background = 'rgba(0, 86, 210, 0.2)';
                                    setTimeout(() => {
                                        if (triggerZone) {
                                            triggerZone.style.width = '20px';
                                            triggerZone.style.background = 'transparent';
                                        }
                                        isHovering = false;
                                    }, 500);
                                }
                            }
                        }
                    }, 200); // Délai réduit pour une réponse plus rapide
                } else if (mouseX > 30) {
                    if (hoverTimeout) {
                        clearTimeout(hoverTimeout);
                        hoverTimeout = null;
                    }
                    isHovering = false;
                }
            });
            
            // Gérer le hover sur la zone de déclenchement
            if (triggerZone) {
                triggerZone.addEventListener('mouseenter', () => {
                    if (!sidebarState.isOpen) {
                        triggerZone.style.background = 'rgba(0, 86, 210, 0.15)';
                        openSidebarOnHover();
                    }
                });
                
                triggerZone.addEventListener('mouseleave', () => {
                    if (triggerZone) {
                        triggerZone.style.background = 'transparent';
                    }
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Vérifier la connexion internet
            checkInternetConnection();
            
            // Écouter les changements de connexion
            window.addEventListener('online', () => {
                hideNoConnectionMessage();
                if (USE_SUPABASE && supabase) {
                    loadFromSupabase();
                }
            });
            window.addEventListener('offline', () => {
                showNoConnectionMessage();
            });
            
            // Charger les données depuis Supabase d'abord
            if (USE_SUPABASE && supabase) {
                await loadFromSupabase();
            }
            
            initData();
            initEventListeners();
            initSidebar(); // Initialiser la sidebar
            showPage('dashboard');
            
            // Mettre à jour les compteurs
            updateCounters();
            updateCartBadge();
            
            // Mettre à jour le nom de la boutique
            updateStoreName();
            
            // Animation du nom toutes les 5 secondes
            setInterval(animateStoreName, 5000);
        });
        
        function checkInternetConnection() {
            if (!navigator.onLine) {
                showNoConnectionMessage();
                return false;
            }
            return true;
        }
        
        function showNoConnectionMessage() {
            // Vérifier si le message existe déjà
            if (document.getElementById('noConnectionMessage')) {
                return;
            }
            
            const messageHTML = `
                <div id="noConnectionMessage" style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 1rem; text-align: center; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideDown 0.3s ease;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; max-width: 1200px; margin: 0 auto;">
                        <i class="fas fa-wifi" style="font-size: 1.5rem; animation: pulse 2s infinite;"></i>
                        <div>
                            <strong style="display: block; font-size: 1.1rem; margin-bottom: 0.25rem;">Pas de connexion internet</strong>
                            <span style="font-size: 0.9rem; opacity: 0.9;">Vérifiez votre connexion réseau et réessayez.</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('afterbegin', messageHTML);
            
            // Ajouter l'animation CSS si elle n'existe pas
            if (!document.getElementById('noConnectionStyles')) {
                const style = document.createElement('style');
                style.id = 'noConnectionStyles';
                style.textContent = `
                    @keyframes slideDown {
                        from {
                            transform: translateY(-100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateY(0);
                            opacity: 1;
                        }
                    }
                    @keyframes pulse {
                        0%, 100% {
                            opacity: 1;
                        }
                        50% {
                            opacity: 0.5;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        function hideNoConnectionMessage() {
            const message = document.getElementById('noConnectionMessage');
            if (message) {
                message.style.animation = 'slideDown 0.3s ease reverse';
                setTimeout(() => {
                    message.remove();
                }, 300);
            }
        }
        
        function initData() {
            // Plus de données fictives - tout sera chargé depuis Supabase
            // Les données seront vides au démarrage et chargées depuis Supabase
        }
        
        function initEventListeners() {
            // Navigation sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    showPage(page);
                    
                    // Mettre à jour la navigation active
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Fermer le menu sur mobile
                    if (window.innerWidth <= 1200) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                });
            });
            
            // Menu toggle
            document.getElementById('menuToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Fermer le menu en cliquant à l'extérieur sur mobile
            document.addEventListener('click', (e) => {
                const sidebar = document.getElementById('sidebar');
                const menuToggle = document.getElementById('menuToggle');
                
                if (window.innerWidth <= 1200 && 
                    sidebar.classList.contains('active') && 
                    !sidebar.contains(e.target) && 
                    !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('active');
                }
            });
            
            // Fermer le menu avec la touche Échap
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && window.innerWidth <= 1200) {
                    document.getElementById('sidebar').classList.remove('active');
                }
            });
        }
        
        // ===== GESTION DES PAGES =====
        function showPage(page) {
            state.currentPage = page;
            
            // Réinitialiser la recherche si on change de page (sauf si on reste sur dashboard ou categories)
            if (page !== 'dashboard' && page !== 'categories') {
                state.searchQuery = '';
            }
            
            // Mettre à jour le titre et l'icône
            document.getElementById('pageTitle').textContent = getPageTitle(page);
            const iconElement = document.getElementById('pageTitleIcon').querySelector('i');
            iconElement.className = `fas ${pageIcons[page]}`;
            
            // Animation de chargement
            const content = document.getElementById('pageContent');
            content.innerHTML = `
                <div class="loader">
                    <div class="loader-spinner"></div>
                    <div>Chargement...</div>
                </div>
            `;
            
            // Simuler un délai de chargement pour l'effet
            setTimeout(() => {
                content.innerHTML = getPageContent(page);
                content.classList.remove('fade-in');
                void content.offsetWidth; // Trigger reflow
                content.classList.add('fade-in');
                
                // Initialiser les composants spécifiques à la page
                initPageComponents(page);
            }, 300);
        }
        
        function getPageTitle(page) {
            const titles = {
                'dashboard': 'Boutique',
                'categories': 'Catégories',
                'cart': 'Mon Panier',
                'add-product': 'Ajouter un produit',
                'customers': 'Clients & Commandes',
                'accounting': 'Comptabilité',
                'analytics': 'Analytiques',
                'settings': 'Paramètres'
            };
            return titles[page] || 'Boutique';
        }
        
        function getPageContent(page) {
            switch(page) {
                case 'dashboard':
                    return getBoutiqueContent();
                case 'categories':
                    return getCategoriesContent();
                case 'cart':
                    return getCartPageContent();
                case 'add-product':
                    return getAddProductContent();
                case 'customers':
                    return getCustomersAndOrdersContent();
                case 'accounting':
                    return getAccountingContent();
                case 'analytics':
                    return getAnalyticsContent();
                case 'settings':
                    return getSettingsContent();
                default:
                    return getBoutiqueContent();
            }
        }
        
        function initPageComponents(page) {
            switch(page) {
                case 'dashboard':
                    const boutiqueSearch = document.getElementById('boutiqueSearch');
                    if (boutiqueSearch) {
                        boutiqueSearch.addEventListener('input', (e) => {
                            state.searchQuery = e.target.value;
                            showPage('dashboard');
                        });
                    }
                    break;
                case 'categories':
                    const categoriesSearch = document.getElementById('categoriesSearch');
                    if (categoriesSearch) {
                        categoriesSearch.addEventListener('input', (e) => {
                            state.searchQuery = e.target.value;
                            showPage('categories');
                        });
                    }
                    break;
                case 'add-product':
                    initImageUpload();
                    initProductPreview();
                    document.getElementById('addProductForm')?.addEventListener('submit', handleAddProduct);
                    break;
                case 'accounting':
                    // Initialiser le scanner si nécessaire
                    setTimeout(() => {
                        const barcodeInput = document.getElementById('barcodeInput');
                        if (barcodeInput) {
                            barcodeInput.focus();
                        }
                    }, 300);
                    break;
                case 'analytics':
                    initCharts();
                    break;
                case 'settings':
                    document.getElementById('settingsForm')?.addEventListener('submit', handleSettingsSave);
                    break;
            }
        }
        
        // ===== BOUTIQUE (Page d'accueil) =====
        function getBoutiqueContent() {
            const filteredProducts = state.searchQuery 
                ? state.products.filter(p => 
                    p.name.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    p.brand.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    p.category.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    (p.description && p.description.toLowerCase().includes(state.searchQuery.toLowerCase()))
                )
                : state.products;
            
            return `
                <!-- Barre de recherche et Panier -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 300px; position: relative;">
                            <input 
                                type="text" 
                                id="boutiqueSearch" 
                                class="form-control" 
                                placeholder="Rechercher un produit, une marque, une catégorie..." 
                                style="padding-left: 3rem; font-size: 1rem;"
                                value="${state.searchQuery}"
                            >
                            <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--secondary-gray);"></i>
                        </div>
                        <button class="btn btn-primary" onclick="showCartModal()" style="position: relative;">
                            <i class="fas fa-shopping-cart"></i> Panier
                            <span id="cartBadge" style="position: absolute; top: -8px; right: -8px; background: var(--danger-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700;">${state.cart.length}</span>
                            </button>
                    </div>
                </div>
                
                <!-- Grille de produits -->
                <div class="products-grid" id="boutiqueProductsGrid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    ${filteredProducts.length > 0 ? filteredProducts.map(product => `
                        <div class="product-card" 
                             style="background: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-sm); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; animation: fadeInUp 0.5s ease; cursor: pointer;"
                             onclick="viewProduct(${product.id})"
                             onmouseenter="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 12px 40px rgba(0,0,0,0.15)'"
                             onmouseleave="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='var(--shadow-sm)'">
                            <div style="position: relative; overflow: hidden;">
                                <img src="${product.images[0] || 'https://via.placeholder.com/300x300?text=Produit'}" 
                                     alt="${product.name}" 
                                     class="product-image"
                                     style="width: 100%; height: 250px; object-fit: cover; transition: transform 0.3s ease;">
                                <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 0.5rem; z-index: 10;">
                                    <button class="btn btn-sm" 
                                            onclick="event.stopPropagation(); toggleFavorite(${product.id})" 
                                            style="background: rgba(255,255,255,0.9); color: ${state.favorites.includes(product.id) ? '#ff4757' : '#666'}; border: none; width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.2s;"
                                            onmouseenter="this.style.transform='scale(1.1)'; this.style.background='rgba(255,255,255,1)'"
                                            onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(255,255,255,0.9)'">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                </div>
                                ${product.stock < 10 && product.stock > 0 ? `
                                    <div style="position: absolute; top: 10px; left: 10px; background: var(--warning-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; z-index: 10;">
                                        Stock faible
                                    </div>
                                ` : ''}
                                ${product.stock === 0 ? `
                                    <div style="position: absolute; top: 10px; left: 10px; background: var(--danger-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; z-index: 10;">
                                        Rupture
                                    </div>
                                ` : ''}
                            </div>
                            <div class="product-info" style="padding: 1.5rem;">
                                <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    ${product.category} • ${product.brand}
                                </div>
                                <div class="product-name" style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--primary-black); line-height: 1.4;">
                                    ${product.name}
                                </div>
                                <div class="product-price" style="font-size: 1.5rem; font-weight: 800; color: var(--primary-blue); margin-bottom: 1rem;">
                                    ${formatPrice(product.price)}
                                </div>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                                    <button class="btn btn-primary" 
                                            onclick="event.stopPropagation(); addToCart(${product.id})" 
                                            style="flex: 1; min-width: 120px; transition: all 0.3s ease;"
                                            onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 86, 210, 0.4)'"
                                            onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                            ${product.stock === 0 ? 'disabled' : ''}>
                                        <i class="fas fa-cart-plus"></i> Ajouter
                                    </button>
                                    <button class="btn" 
                                            onclick="event.stopPropagation(); viewProduct(${product.id})" 
                                            style="background: #e9ecef; color: var(--primary-black); flex: 1; min-width: 120px; transition: all 0.3s ease;"
                                            onmouseenter="this.style.background='#dee2e6'; this.style.transform='translateY(-2px)'"
                                            onmouseleave="this.style.background='#e9ecef'; this.style.transform='translateY(0)'">
                                        <i class="fas fa-eye"></i> Voir
                                    </button>
                                </div>
                                <div style="display: flex; gap: 0.5rem; border-top: 1px solid #e9ecef; padding-top: 0.75rem; margin-top: 0.75rem;">
                                    <button class="btn btn-sm" 
                                            onclick="event.stopPropagation(); editProduct(${product.id})" 
                                            style="flex: 1; background: var(--primary-blue); color: white; border: none; padding: 0.5rem; border-radius: var(--border-radius-sm); font-size: 0.85rem; transition: all 0.3s ease;"
                                            onmouseenter="this.style.background='#0044a8'; this.style.transform='translateY(-2px)'"
                                            onmouseleave="this.style.background='var(--primary-blue)'; this.style.transform='translateY(0)'">
                                        <i class="fas fa-edit"></i> Modifier
                                    </button>
                                    <button class="btn btn-sm" 
                                            onclick="event.stopPropagation(); deleteProduct(${product.id})" 
                                            style="flex: 1; background: var(--danger-color); color: white; border: none; padding: 0.5rem; border-radius: var(--border-radius-sm); font-size: 0.85rem; transition: all 0.3s ease;"
                                            onmouseenter="this.style.background='#c82333'; this.style.transform='translateY(-2px)'"
                                            onmouseleave="this.style.background='var(--danger-color)'; this.style.transform='translateY(0)'">
                                        <i class="fas fa-trash"></i> Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('') : `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 4rem 2rem;">
                            <i class="fas fa-search" style="font-size: 4rem; color: var(--secondary-gray); margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3 style="color: var(--primary-black); margin-bottom: 0.5rem;">Aucun produit trouvé</h3>
                            <p style="color: var(--secondary-gray);">Essayez de modifier vos critères de recherche</p>
                        </div>
                    `}
                    </div>
                    
                ${filteredProducts.length === 0 && !state.searchQuery ? `
                    <div style="text-align: center; padding: 4rem 2rem;">
                        <i class="fas fa-box-open" style="font-size: 4rem; color: var(--secondary-gray); margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3 style="color: var(--primary-black); margin-bottom: 0.5rem;">Aucun produit disponible</h3>
                        <p style="color: var(--secondary-gray); margin-bottom: 2rem;">Commencez par ajouter vos premiers produits</p>
                        <button class="btn btn-primary" onclick="showPage('add-product')">
                            <i class="fas fa-plus"></i> Ajouter un produit
                        </button>
                            </div>
                ` : ''}
            `;
        }
        
        // ===== CATÉGORIES (Style Alibaba) =====
        function getCategoriesContent() {
            // Récupérer toutes les catégories uniques
            const allCategories = [...new Set([
                ...state.products.map(p => p.category),
                ...state.customCategories
            ])];
            
            const allBrands = [...new Set([
                ...state.products.map(p => p.brand),
                ...state.customBrands
            ])];
            
            let filteredProducts;
            if (state.currentFilter === 'favorites') {
                filteredProducts = state.products.filter(p => state.favorites.includes(p.id));
            } else if (state.currentFilter === 'category' && state.searchQuery) {
                filteredProducts = state.products.filter(p => p.category === state.searchQuery);
            } else if (state.currentFilter === 'brand' && state.searchQuery) {
                filteredProducts = state.products.filter(p => p.brand === state.searchQuery);
            } else if (state.searchQuery) {
                filteredProducts = state.products.filter(p => 
                    p.name.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    p.brand.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    p.category.toLowerCase().includes(state.searchQuery.toLowerCase())
                );
            } else {
                filteredProducts = state.products;
            }
            
            return `
                <!-- Barre de recherche -->
                <div style="margin-bottom: 2rem;">
                    <div style="position: relative; max-width: 600px;">
                        <input 
                            type="text" 
                            id="categoriesSearch" 
                            class="form-control" 
                            placeholder="Rechercher dans les catégories..." 
                            style="padding-left: 3rem; font-size: 1rem;"
                            value="${state.searchQuery}"
                        >
                        <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--secondary-gray);"></i>
                        </div>
                    </div>
                    
                <!-- Catégories principales -->
                <div class="form-section" style="margin-bottom: 2rem; animation: fadeIn 0.5s ease;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-blue); display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-th-large"></i>
                        <span>Catégories (${allCategories.length + 1})</span>
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                        <!-- Favoris -->
                        <div class="category-card" 
                             onclick="filterByFavorites()"
                             style="background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%); 
                                    border: 2px solid #ff4757; 
                                    border-radius: var(--border-radius); 
                                    padding: 1.5rem; 
                                    cursor: pointer; 
                                    transition: all 0.3s ease; 
                                    box-shadow: var(--shadow-sm);
                                    animation: slideInLeft 0.3s ease;
                                    color: white;">
                            <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-heart"></i>
                                <span>Favoris</span>
                            </div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">
                                ${state.favorites.length} produit${state.favorites.length > 1 ? 's' : ''}
                            </div>
                        </div>
                        
                        ${allCategories.map((category, index) => {
                            const categoryProducts = state.products.filter(p => p.category === category);
                            return `
                                <div class="category-card" 
                                     onclick="filterByCategory('${category}')"
                                     style="background: white; 
                                            border: 2px solid var(--primary-blue); 
                                            border-radius: var(--border-radius); 
                                            padding: 1.5rem; 
                                            cursor: pointer; 
                                            transition: all 0.3s ease; 
                                            box-shadow: var(--shadow-sm);
                                            animation: slideInLeft ${0.1 * index + 0.4}s ease;">
                                    <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--primary-blue);">
                                        ${category}
                                    </div>
                                    <div style="font-size: 0.9rem; color: var(--secondary-gray);">
                                        ${categoryProducts.length} produit${categoryProducts.length > 1 ? 's' : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Marques -->
                <div class="form-section" style="margin-bottom: 2rem; animation: fadeIn 0.6s ease;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-blue); display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-tags"></i>
                        <span>Marques (${allBrands.length})</span>
                    </h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                        ${allBrands.map((brand, index) => {
                            const brandProducts = state.products.filter(p => p.brand === brand);
                            return `
                                <div class="brand-badge" 
                                     onclick="filterByBrand('${brand}')"
                                     style="background: white; 
                                            border: 2px solid var(--primary-blue); 
                                            border-radius: 30px; 
                                            padding: 0.75rem 1.5rem; 
                                            cursor: pointer; 
                                            transition: all 0.3s ease; 
                                            box-shadow: var(--shadow-sm);
                                            animation: fadeInUp ${0.05 * index + 0.3}s ease;">
                                    <span style="font-weight: 600; color: var(--primary-blue);">
                                        ${brand}
                                    </span>
                                    <span style="margin-left: 0.5rem; color: var(--secondary-gray); font-size: 0.85rem;">
                                        (${brandProducts.length})
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                        </div>
                        
                <!-- Produits par catégorie -->
                <div class="form-section" style="animation: fadeIn 0.7s ease;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-blue); display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-box"></i>
                        <span>${state.currentFilter === 'favorites' ? 'Mes favoris' : state.currentFilter === 'category' ? `Catégorie: ${state.searchQuery}` : state.currentFilter === 'brand' ? `Marque: ${state.searchQuery}` : 'Tous les produits'} (${filteredProducts.length})</span>
                    </h3>
                    <div class="products-grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
                        ${filteredProducts.length > 0 ? filteredProducts.map((product, index) => `
                            <div class="product-card" 
                                 style="background: white; 
                                        border-radius: var(--border-radius); 
                                        overflow: hidden; 
                                        box-shadow: var(--shadow-sm); 
                                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                                        position: relative;
                                        animation: fadeInUp ${0.05 * index + 0.3}s ease;
                                        cursor: pointer;"
                                 onmouseenter="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 12px 40px rgba(0,0,0,0.15)'"
                                 onmouseleave="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='var(--shadow-sm)'"
                                 onclick="viewProduct(${product.id})">
                                <div style="position: relative; overflow: hidden;">
                                    <img src="${product.images[0] || 'https://via.placeholder.com/300x300?text=Produit'}" 
                                         alt="${product.name}" 
                                         style="width: 100%; height: 200px; object-fit: cover; transition: transform 0.3s ease;"
                                         onmouseenter="this.style.transform='scale(1.1)'"
                                         onmouseleave="this.style.transform='scale(1)'">
                                    <div style="position: absolute; top: 10px; right: 10px;">
                                        <button class="btn btn-sm" 
                                                onclick="event.stopPropagation(); toggleFavorite(${product.id})" 
                                                style="background: rgba(255,255,255,0.9); color: ${state.favorites.includes(product.id) ? '#ff4757' : '#666'}; border: none; width: 35px; height: 35px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <i class="fas fa-heart"></i>
                                            </button>
                                    </div>
                                </div>
                                <div style="padding: 1.25rem;">
                                    <div style="font-size: 0.8rem; color: var(--secondary-gray); margin-bottom: 0.5rem; text-transform: uppercase;">
                                        ${product.category} • ${product.brand}
                                    </div>
                                    <div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.75rem; color: var(--primary-black); line-height: 1.4; height: 2.8rem; overflow: hidden;">
                                        ${product.name}
                                    </div>
                                    <div style="font-size: 1.3rem; font-weight: 800; color: var(--primary-blue); margin-bottom: 1rem;">
                                        ${formatPrice(product.price)}
                                    </div>
                                    <button class="btn btn-primary" 
                                            onclick="event.stopPropagation(); addToCart(${product.id})" 
                                            style="width: 100%; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;"
                                            onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(0, 86, 210, 0.4)'"
                                            onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                            ${product.stock === 0 ? 'disabled' : ''}>
                                        <i class="fas fa-cart-plus"></i> Ajouter au panier
                                    </button>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; border-top: 1px solid #e9ecef; padding-top: 0.75rem;">
                                        <button class="btn btn-sm" 
                                                onclick="event.stopPropagation(); editProduct(${product.id})" 
                                                style="flex: 1; background: var(--primary-blue); color: white; border: none; padding: 0.5rem; border-radius: var(--border-radius-sm); font-size: 0.85rem; transition: all 0.3s ease;"
                                                onmouseenter="this.style.background='#0044a8'; this.style.transform='translateY(-2px)'"
                                                onmouseleave="this.style.background='var(--primary-blue)'; this.style.transform='translateY(0)'">
                                            <i class="fas fa-edit"></i> Modifier
                                        </button>
                                        <button class="btn btn-sm" 
                                                onclick="event.stopPropagation(); deleteProduct(${product.id})" 
                                                style="flex: 1; background: var(--danger-color); color: white; border: none; padding: 0.5rem; border-radius: var(--border-radius-sm); font-size: 0.85rem; transition: all 0.3s ease;"
                                                onmouseenter="this.style.background='#c82333'; this.style.transform='translateY(-2px)'"
                                                onmouseleave="this.style.background='var(--danger-color)'; this.style.transform='translateY(0)'">
                                            <i class="fas fa-trash"></i> Supprimer
                                        </button>
                                    </div>
                                        </div>
                                    </div>
                        `).join('') : `
                            <div style="grid-column: 1 / -1; text-align: center; padding: 4rem 2rem;">
                                <i class="fas fa-search" style="font-size: 4rem; color: var(--secondary-gray); margin-bottom: 1rem; opacity: 0.5;"></i>
                                <h3 style="color: var(--primary-black); margin-bottom: 0.5rem;">Aucun produit trouvé</h3>
                                <p style="color: var(--secondary-gray);">Essayez de modifier vos critères de recherche</p>
                                </div>
                        `}
                        </div>
                    </div>
            `;
        }
                    
        // ===== PAGE PANIER =====
        function getCartPageContent() {
            const total = state.cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            
            return `
                    <div class="form-section">
                    <h3 style="margin-bottom: 2rem; color: var(--primary-blue); display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Mon Panier (${state.cart.length} article${state.cart.length > 1 ? 's' : ''})</span>
                    </h3>
                    
                    ${state.cart.length > 0 ? `
                        <div style="display: grid; gap: 1.5rem; margin-bottom: 2rem;">
                            ${state.cart.map(item => `
                                <div style="display: flex; gap: 1.5rem; padding: 1.5rem; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); align-items: center; flex-wrap: wrap; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); animation: fadeInUp 0.3s ease;" onmouseenter="this.style.transform='translateX(5px)'; this.style.boxShadow='var(--shadow-md)'" onmouseleave="this.style.transform='translateX(0)'; this.style.boxShadow='var(--shadow-sm)'">
                                    <img src="${item.product.images[0]}" style="width: 120px; height: 120px; object-fit: cover; border-radius: var(--border-radius-sm); box-shadow: var(--shadow-sm); transition: transform 0.3s ease;" onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform='scale(1)'">
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--primary-black);">
                                            ${item.product.name}
                                        </div>
                                        <div style="font-size: 0.9rem; color: var(--secondary-gray); margin-bottom: 0.5rem;">
                                            ${item.product.brand} • ${item.product.category}
                                        </div>
                                        <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary-blue);">
                                            ${formatPrice(item.product.price)}
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #f8f9fa; padding: 0.5rem; border-radius: var(--border-radius-sm);">
                                            <button onclick="updateCartQuantity(${item.productId}, ${item.quantity - 1})" 
                                                    style="background: white; border: 1px solid #dee2e6; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-weight: 700; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" 
                                                    onmouseenter="this.style.background='var(--danger-color)'; this.style.color='white'; this.style.borderColor='var(--danger-color)'; this.style.transform='scale(1.1)'"
                                                    onmouseleave="this.style.background='white'; this.style.color='var(--primary-black)'; this.style.borderColor='#dee2e6'; this.style.transform='scale(1)'">
                                                -
                                            </button>
                                            <span style="min-width: 40px; text-align: center; font-weight: 700; font-size: 1.1rem;">${item.quantity}</span>
                                            <button onclick="updateCartQuantity(${item.productId}, ${item.quantity + 1})" 
                                                    style="background: var(--primary-blue); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-weight: 700; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" 
                                                    onmouseenter="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(0, 86, 210, 0.4)'"
                                                    onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                                                +
                                            </button>
                                        </div>
                                        <div style="font-weight: 800; font-size: 1.2rem; color: var(--primary-blue); min-width: 120px; text-align: right;">
                                            ${formatPrice(item.product.price * item.quantity)}
                                        </div>
                                        <button onclick="removeFromCart(${item.productId})" 
                                                style="background: var(--danger-color); color: white; border: none; padding: 0.75rem 1rem; border-radius: var(--border-radius-sm); cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" 
                                                onmouseenter="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(220, 53, 69, 0.4)'"
                                                onmouseleave="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='none'">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                    `).join('')}
                        </div>
                        
                        <div style="background: white; padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); position: sticky; bottom: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e9ecef;">
                                <span style="font-size: 1.3rem; font-weight: 700; color: var(--primary-black);">Total:</span>
                                <span style="font-size: 2rem; font-weight: 800; color: var(--primary-blue);">${formatPrice(total)}</span>
                    </div>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn" onclick="showPage('dashboard')" style="background: #e9ecef; flex: 1; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseenter="this.style.transform='translateX(-3px)'; this.style.background='#dee2e6'" onmouseleave="this.style.transform='translateX(0)'; this.style.background='#e9ecef'">
                                    <i class="fas fa-arrow-left"></i> Continuer les achats
                                </button>
                                <button class="btn btn-primary" onclick="checkout()" style="flex: 2; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0, 86, 210, 0.4)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <i class="fas fa-check"></i> Passer la commande
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 4rem 2rem; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
                            <i class="fas fa-shopping-cart" style="font-size: 5rem; color: var(--secondary-gray); opacity: 0.3; margin-bottom: 1.5rem;"></i>
                            <h3 style="color: var(--primary-black); margin-bottom: 0.5rem;">Votre panier est vide</h3>
                            <p style="color: var(--secondary-gray); margin-bottom: 2rem;">Ajoutez des produits depuis la boutique pour commencer</p>
                            <button class="btn btn-primary" onclick="showPage('dashboard')">
                                <i class="fas fa-store"></i> Voir la boutique
                            </button>
                        </div>
                    `}
                </div>
            `;
        }
        
        // ===== PRODUITS =====
        function getProductsContent() {
            return `
                <div class="form-section">
                    <div class="table-header">
                        <div class="table-title">Tous les produits (${state.products.length})</div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-whatsapp" onclick="exportProducts()">
                                <i class="fas fa-file-export"></i> Exporter
                            </button>
                            <button class="btn btn-primary" onclick="showPage('add-product')">
                                <i class="fas fa-plus"></i> Ajouter un produit
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th>Catégorie</th>
                                    <th>Prix</th>
                                    <th>Stock</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                ${state.products.map(product => `
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                <img src="${product.images[0]}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                                <div>
                                                    <div style="font-weight: 700;">${product.name}</div>
                                                    <div style="font-size: 0.9rem; color: var(--secondary-gray);">${product.brand}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>${product.category}</td>
                                        <td style="font-weight: 800; color: var(--primary-blue);">${formatPrice(product.price)}</td>
                                        <td>
                                            <span class="badge" style="background: ${product.stock > 10 ? '#28a745' : product.stock > 0 ? '#ffc107' : '#dc3545'}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; box-shadow: 0 3px 8px rgba(0,0,0,0.1);">
                                                ${product.stock} unités
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge" style="background: ${product.stock > 0 ? '#28a745' : '#dc3545'}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; box-shadow: 0 3px 8px rgba(0,0,0,0.1);">
                                                ${product.stock > 0 ? 'En stock' : 'Rupture'}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-primary" onclick="editProduct(${product.id})" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})" title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                <button class="btn btn-sm btn-whatsapp" onclick="shareProduct(${product.id})" title="Partager">
                                                    <i class="fab fa-whatsapp"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // ===== AJOUTER UN PRODUIT =====
        function getAddProductContent() {
            return `
                <div class="form-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h3 style="color: var(--primary-blue); display: flex; align-items: center; gap: 1rem; margin: 0;">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--primary-blue), var(--accent-color)); display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fas fa-plus"></i>
                            </div>
                            <span>${state.currentProduct ? 'Modifier le produit' : 'Ajouter un nouveau produit'}</span>
                        </h3>
                        <button type="button" id="togglePreviewBtn" onclick="togglePreviewPanel()" class="btn" style="background: linear-gradient(135deg, var(--primary-blue), var(--accent-color)); color: white; padding: 0.75rem 1.5rem; border-radius: var(--border-radius-sm); border: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; box-shadow: var(--shadow-md); transition: var(--transition);">
                            <i class="fas fa-eye" id="previewIcon"></i>
                            <span id="previewBtnText">Aperçu en direct</span>
                        </button>
                    </div>
                    
                    <div id="formPreviewContainer" style="display: grid; grid-template-columns: 1fr 450px; gap: 2rem; position: relative;">
                        <!-- Formulaire -->
                        <div style="transition: var(--transition);">
                            <form id="addProductForm">
                        <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Nom du produit *</label>
                                    <input type="text" class="form-control" id="productName" placeholder="Ex: iPhone 14 Pro Max 256GB" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Marque *</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <select class="form-select" id="productBrand" required style="flex: 1;">
                                        <option value="">Sélectionnez une marque</option>
                                        <option value="Apple">Apple</option>
                                        <option value="Samsung">Samsung</option>
                                        <option value="Sony">Sony</option>
                                        <option value="Nike">Nike</option>
                                        <option value="Adidas">Adidas</option>
                                        <option value="Canon">Canon</option>
                                        <option value="HP">HP</option>
                                        <option value="Dell">Dell</option>
                                            ${state.customBrands.map(brand => `<option value="${brand}">${brand}</option>`).join('')}
                                    </select>
                                        <button type="button" class="btn" onclick="showAddBrandModal()" style="background: var(--primary-blue); color: white; padding: 0.75rem 1rem; border-radius: var(--border-radius-sm); border: none; cursor: pointer; white-space: nowrap;">
                                            <i class="fas fa-plus"></i> Nouvelle
                                        </button>
                                        ${state.customBrands.length > 0 ? `
                                        <button type="button" class="btn" onclick="showManageBrandsModal()" style="background: var(--accent-color); color: white; padding: 0.75rem 1rem; border-radius: var(--border-radius-sm); border: none; cursor: pointer; white-space: nowrap;">
                                            <i class="fas fa-cog"></i> Gérer
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Catégorie *</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <select class="form-select" id="productCategory" required style="flex: 1;">
                                        <option value="">Sélectionnez une catégorie</option>
                                        <option value="Électronique">Électronique</option>
                                        <option value="Mode">Mode</option>
                                        <option value="Maison">Maison</option>
                                        <option value="Beauté">Beauté</option>
                                        <option value="Sport">Sport</option>
                                        <option value="Informatique">Informatique</option>
                                        <option value="Photographie">Photographie</option>
                                            ${state.customCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                    </select>
                                        <button type="button" class="btn" onclick="showAddCategoryModal()" style="background: var(--accent-color); color: white; padding: 0.75rem 1rem; border-radius: var(--border-radius-sm); border: none; cursor: pointer; white-space: nowrap;">
                                            <i class="fas fa-plus"></i> Nouvelle
                                        </button>
                                        ${state.customCategories.length > 0 ? `
                                        <button type="button" class="btn" onclick="showManageCategoriesModal()" style="background: var(--primary-blue); color: white; padding: 0.75rem 1rem; border-radius: var(--border-radius-sm); border: none; cursor: pointer; white-space: nowrap;">
                                            <i class="fas fa-cog"></i> Gérer
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Prix (FCFA) *</label>
                                    <input type="number" class="form-control" id="productPrice" placeholder="Ex: 850000" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Stock disponible *</label>
                                    <input type="number" class="form-control" id="productStock" placeholder="10" required>
                                </div>
                            </div>
                            
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Description détaillée</label>
                                    <textarea class="form-control" id="productDescription" rows="6" placeholder="Décrivez votre produit..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Promotion (optionnel)</label>
                                    <select class="form-select" id="productPromotion">
                                        <option value="">Aucune promotion</option>
                                        ${state.promotions.map(promo => `
                                            <option value="${promo.id}">${promo.name} - ${promo.discount}%</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Tags/Mots-clés</label>
                                    <input type="text" class="form-control" id="productTags" placeholder="Ex: smartphone, apple, neuf, garantie">
                                    <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-top: 0.25rem;">
                                        Séparez par des virgules
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">URL d'image (optionnel)</label>
                                    <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/image.jpg">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload d'images -->
                        <div class="form-group">
                            <label class="form-label">Images du produit * (Maximum 10 photos)</label>
                            <div class="image-upload-area" id="imageUploadArea" style="border: 3px dashed #e9ecef; border-radius: var(--border-radius); padding: 3rem; text-align: center; cursor: pointer; transition: var(--transition);">
                                <div class="upload-icon" style="font-size: 3rem; color: var(--secondary-gray); margin-bottom: 1rem;">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <div class="upload-text">
                                    Glissez-déposez vos images ici<br>
                                    ou cliquez pour parcourir
                                </div>
                                <div style="font-size: 0.9rem; color: var(--secondary-gray); margin-top: 0.5rem;">
                                    Formats acceptés: JPG, PNG, GIF | Compression automatique à ≤100KB | Maximum 10 photos
                                </div>
                                <div id="imageCount" style="font-size: 0.85rem; color: var(--primary-blue); margin-top: 0.5rem; font-weight: 600;">
                                    0 / 10 photos
                                </div>
                            </div>
                            <input type="file" id="imageUploadInput" accept="image/*" multiple style="display: none;">
                            <div class="image-preview-grid" id="imagePreviewGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem;"></div>
                        </div>
                        
                        <div class="d-flex gap-3" style="margin-top: 2rem;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> ${state.currentProduct ? 'Mettre à jour' : 'Enregistrer le produit'}
                            </button>
                            <button type="button" class="btn" onclick="showPage('dashboard')" style="background: #e9ecef;">
                                <i class="fas fa-times"></i> Annuler
                            </button>
                        </div>
                    </form>
                        </div>
                        
                        <!-- Panneau de prévisualisation -->
                        <div id="previewPanel" style="position: sticky; top: 2rem; height: fit-content; max-height: calc(100vh - 4rem); overflow-y: auto;">
                            <div style="background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); border: 2px solid var(--primary-blue); padding: 1.5rem; position: relative;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
                                    <h4 style="color: var(--primary-blue); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-eye"></i>
                                        <span>Aperçu produit</span>
                                    </h4>
                                    <div style="font-size: 0.75rem; color: var(--secondary-gray); background: rgba(0, 86, 210, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px;">
                                        En direct
                                    </div>
                                </div>
                                
                                <div id="productPreview" style="animation: fadeIn 0.3s ease;">
                                    <!-- Le contenu sera généré dynamiquement -->
                                    <div style="text-align: center; padding: 3rem 2rem; color: var(--secondary-gray);">
                                        <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                        <p style="margin: 0;">Commencez à remplir le formulaire pour voir l'aperçu</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ===== PROMOTIONS =====
        function getPromotionsContent() {
            return `
                <div class="form-section">
                    <div class="table-header">
                        <div class="table-title">Promotions actives (${state.promotions.length})</div>
                        <button class="btn btn-success" onclick="showAddPromotionModal()">
                            <i class="fas fa-plus"></i> Nouvelle promotion
                        </button>
                    </div>
                    
                    <div class="promotions-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                        ${state.promotions.map(promo => `
                            <div class="promotion-card" style="background: white; border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.05); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(to right, var(--success-color), #20bf6b);"></div>
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                    <div>
                                        <h4 style="font-weight: 700; color: var(--primary-blue); margin-bottom: 0.25rem;">${promo.name}</h4>
                                        <div style="font-size: 0.9rem; color: var(--secondary-gray);">
                                            ${new Date(promo.startDate).toLocaleDateString()} - ${new Date(promo.endDate).toLocaleDateString()}
                                        </div>
                                    </div>
                                    <span style="background: linear-gradient(135deg, var(--success-color), #20bf6b); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 700; box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);">
                                        -${promo.discount}%
                                    </span>
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.9rem; color: var(--secondary-gray); margin-bottom: 0.5rem;">Produits concernés:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        ${promo.products.map(productId => {
                                            const product = state.products.find(p => p.id === productId);
                                            return product ? `
                                                <span style="background: rgba(0, 86, 210, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; color: var(--primary-blue); border: 1px solid rgba(0, 86, 210, 0.2);">
                                                    ${product.name.substring(0, 20)}${product.name.length > 20 ? '...' : ''}
                                                </span>
                                            ` : '';
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-danger" onclick="deletePromotion(${promo.id})">
                                        <i class="fas fa-trash"></i> Supprimer
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // ===== COMMANDES =====
        function getOrdersContent() {
            return `
                <div class="form-section">
                    <div class="table-header">
                        <div class="table-title">Commandes (${state.orders.length})</div>
                        <div class="d-flex gap-2">
                            <button class="btn" style="background: #e9ecef;" onclick="filterOrders('all')">
                                Toutes (${state.orders.length})
                            </button>
                            <button class="btn btn-warning" onclick="filterOrders('pending')">
                                En attente (${state.orders.filter(o => o.status === 'pending').length})
                            </button>
                            <button class="btn btn-primary" onclick="filterOrders('processing')">
                                En cours (${state.orders.filter(o => o.status === 'processing').length})
                            </button>
                            <button class="btn btn-success" onclick="filterOrders('delivered')">
                                Livrées (${state.orders.filter(o => o.status === 'delivered').length})
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID Commande</th>
                                    <th>Client</th>
                                    <th>Produits</th>
                                    <th>Total</th>
                                    <th>Statut</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.orders.map(order => `
                                    <tr>
                                        <td style="font-weight: 700; color: var(--primary-blue);">#${order.id.toString().substring(0, 8)}</td>
                                        <td>
                                            <div>
                                                <div style="font-weight: 700;">${order.customer?.name || 'Non spécifié'}</div>
                                                <div style="font-size: 0.9rem; color: var(--secondary-gray);">${order.customer?.phone || ''}</div>
                                            </div>
                                        </td>
                                        <td>
                                            <div>${order.items.length} produit(s)</div>
                                            <div style="font-size: 0.9rem; color: var(--secondary-gray);">
                                                ${order.items.map(item => item.name.substring(0, 15)).join(', ')}
                                            </div>
                                        </td>
                                        <td style="font-weight: 800; color: var(--primary-blue);">${formatPrice(order.total)}</td>
                                        <td>
                                            <span class="badge" style="background: ${getStatusColor(order.status)}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; box-shadow: 0 3px 8px rgba(0,0,0,0.1);">
                                                ${getStatusText(order.status)}
                                            </span>
                                        </td>
                                        <td>${new Date(order.date).toLocaleDateString()}</td>
                                        <td>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-primary" onclick="viewOrder(${order.id})" title="Voir détails">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-whatsapp" onclick="contactCustomer(${order.id})" title="Contacter">
                                                    <i class="fab fa-whatsapp"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // ===== CLIENTS & COMMANDES =====
        function getCustomersAndOrdersContent() {
            return `
                <!-- Clients -->
                <div class="form-section" style="margin-bottom: 2rem;">
                    <div class="table-header">
                        <div class="table-title">Clients (${state.customers.length})</div>
                        <button class="btn btn-primary" onclick="exportCustomers()">
                            <i class="fas fa-file-export"></i> Exporter
                        </button>
                    </div>
                    
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Email</th>
                                    <th>Téléphone</th>
                                    <th>Commandes</th>
                                    <th>Dépenses totales</th>
                                    <th>Inscrit le</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.customers.map(customer => {
                                    const customerOrders = state.orders.filter(o => o.customer?.id === customer.id || o.customer?.name === customer.name);
                                    return `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 1rem;">
                                                    <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-blue), var(--accent-color)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; box-shadow: 0 5px 15px rgba(0, 86, 210, 0.3);">
                                                        ${customer.name.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <div style="font-weight: 700;">${customer.name}</div>
                                                        <div style="font-size: 0.9rem; color: var(--secondary-gray);">Client #${customer.id}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>${customer.email || '-'}</td>
                                            <td>${customer.phone || '-'}</td>
                                            <td style="font-weight: 700; color: var(--primary-blue);">${customerOrders.length}</td>
                                            <td style="font-weight: 800; color: var(--primary-blue);">${formatPrice(customer.totalSpent || 0)}</td>
                                            <td>${new Date(customer.joined).toLocaleDateString()}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Commandes -->
                <div class="form-section">
                    <div class="table-header">
                        <div class="table-title">Commandes (${state.orders.length})</div>
                        <div class="d-flex gap-2">
                            <button class="btn" style="background: #e9ecef;" onclick="filterOrders('all')">
                                Toutes (${state.orders.length})
                            </button>
                            <button class="btn btn-warning" onclick="filterOrders('pending')">
                                En attente (${state.orders.filter(o => o.status === 'pending').length})
                            </button>
                            <button class="btn btn-primary" onclick="filterOrders('processing')">
                                En cours (${state.orders.filter(o => o.status === 'processing').length})
                            </button>
                            <button class="btn btn-success" onclick="filterOrders('delivered')">
                                Livrées (${state.orders.filter(o => o.status === 'delivered').length})
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID Commande</th>
                                    <th>Client</th>
                                    <th>Produits</th>
                                    <th>Total</th>
                                    <th>Statut</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.orders.map(order => `
                                    <tr>
                                        <td style="font-weight: 700; color: var(--primary-blue);">#${order.id.toString().substring(0, 8)}</td>
                                        <td>
                                            <div>
                                                <div style="font-weight: 700;">${order.customer?.name || 'Non spécifié'}</div>
                                                <div style="font-size: 0.9rem; color: var(--secondary-gray);">${order.customer?.phone || ''}</div>
                                            </div>
                                        </td>
                                        <td>
                                            <div>${order.items.length} produit(s)</div>
                                            <div style="font-size: 0.9rem; color: var(--secondary-gray);">
                                                ${order.items.map(item => item.name.substring(0, 15)).join(', ')}
                                            </div>
                                        </td>
                                        <td style="font-weight: 800; color: var(--primary-blue);">${formatPrice(order.total)}</td>
                                        <td>
                                            <span class="badge" style="background: ${getStatusColor(order.status)}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; box-shadow: 0 3px 8px rgba(0,0,0,0.1);">
                                                ${getStatusText(order.status)}
                                            </span>
                                        </td>
                                        <td>${new Date(order.date).toLocaleDateString()}</td>
                                        <td>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-primary" onclick="viewOrder(${order.id})" title="Voir détails">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-whatsapp" onclick="contactCustomer(${order.id})" title="Contacter">
                                                    <i class="fab fa-whatsapp"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // ===== COMPTABILITÉ =====
        function getAccountingContent() {
            // Calculer les statistiques
            const today = new Date().toDateString();
            const todaySales = state.sales || [];
            const todaySalesFiltered = todaySales.filter(sale => new Date(sale.date).toDateString() === today);
            const todayRevenue = todaySalesFiltered.reduce((sum, sale) => sum + sale.total, 0);
            const todayQuantity = todaySalesFiltered.reduce((sum, sale) => sum + sale.quantity, 0);
            const totalProducts = state.products.length;
            const soldToday = todaySalesFiltered.length;
            
            return `
                <!-- En-tête avec sélecteur de devise -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <h3 style="color: var(--primary-blue); margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-calculator"></i>
                        <span>Comptabilité</span>
                    </h3>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <label style="font-weight: 600; color: var(--primary-black);">Devise:</label>
                        <select id="currencySelector" class="form-select" style="min-width: 150px;" onchange="updateCurrency()">
                            <option value="FCFA" ${state.settings.currency === 'FCFA' ? 'selected' : ''}>FCFA (Franc CFA)</option>
                            <option value="EUR" ${state.settings.currency === 'EUR' ? 'selected' : ''}>EUR (Euro)</option>
                            <option value="USD" ${state.settings.currency === 'USD' ? 'selected' : ''}>USD (Dollar)</option>
                            <option value="XOF" ${state.settings.currency === 'XOF' ? 'selected' : ''}>XOF (Franc Ouest-Africain)</option>
                            <option value="XAF" ${state.settings.currency === 'XAF' ? 'selected' : ''}>XAF (Franc CFA BEAC)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Cartes statistiques -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Ventes aujourd'hui</div>
                            <div class="stat-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                        </div>
                        <div class="stat-value">${todayQuantity}</div>
                        <div class="stat-change">
                            <i class="fas fa-chart-line" style="color: #28a745"></i>
                            ${soldToday} transaction${soldToday > 1 ? 's' : ''}
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Revenus aujourd'hui</div>
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="todayRevenue">${formatPrice(todayRevenue)}</div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up" style="color: #28a745"></i>
                            Chiffre d'affaires
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total produits</div>
                            <div class="stat-icon">
                                <i class="fas fa-box"></i>
                            </div>
                        </div>
                        <div class="stat-value">${totalProducts}</div>
                        <div class="stat-change">
                            <i class="fas fa-database" style="color: var(--primary-blue)"></i>
                            En stock
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Vendus aujourd'hui</div>
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="stat-value">${soldToday}</div>
                        <div class="stat-change">
                            <i class="fas fa-percentage" style="color: var(--accent-color)"></i>
                            ${totalProducts > 0 ? ((soldToday / totalProducts) * 100).toFixed(1) : 0}% du total
                        </div>
                    </div>
                </div>
                
                <!-- Scanner et vente -->
                <div class="form-section" style="margin-bottom: 2rem;">
                    <div class="table-header">
                        <div class="table-title">Scanner & Vente</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <div id="scannerStatus" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #e9ecef; border-radius: 20px; font-size: 0.85rem;">
                                <i class="fas fa-circle" style="color: var(--secondary-gray); font-size: 0.6rem;"></i>
                                <span>Scanner non détecté</span>
                            </div>
                            <button class="btn btn-primary" onclick="initBarcodeScanner()">
                                <i class="fas fa-barcode"></i> Activer le scanner
                            </button>
                            <button class="btn btn-sm" onclick="requestUSBAccess()" style="background: #6c757d; color: white;" title="Détecter les scanners USB">
                                <i class="fas fa-usb"></i> Détecter USB
                            </button>
                            <button class="btn btn-success" onclick="showAddProductByScanModal()" style="background: #28a745;">
                                <i class="fas fa-plus-circle"></i> Ajouter un produit par scan
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem;">
                        <!-- Scanner -->
                        <div style="background: white; padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-blue);">
                                <i class="fas fa-qrcode"></i> Scanner un produit
                            </h4>
                            <div id="barcodeInputArea" style="margin-bottom: 1rem;">
                                <input 
                                    type="text" 
                                    id="barcodeInput" 
                                    class="form-control" 
                                    placeholder="Scannez ou entrez le code-barres/QR code"
                                    style="font-size: 1.1rem; padding: 1rem;"
                                    autocomplete="off"
                                >
                                <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-top: 0.5rem;">
                                    <i class="fas fa-info-circle"></i> Le scanner sera détecté automatiquement
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="processBarcodeScan()" style="width: 100%;">
                                <i class="fas fa-check"></i> Valider la vente
                            </button>
                        </div>
                        
                        <!-- Vente manuelle -->
                        <div style="background: white; padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-blue);">
                                <i class="fas fa-hand-pointer"></i> Vente manuelle
                            </h4>
                            <div class="form-group">
                                <label class="form-label">Sélectionner un produit</label>
                                <select id="manualProductSelect" class="form-select" onchange="selectProductForSale(this.value)">
                                    <option value="">Choisir un produit...</option>
                                    ${state.products.map(p => `
                                        <option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}">
                                            ${p.name} - ${formatPrice(p.price)} (Stock: ${p.stock})
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            <div id="selectedProductInfo" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius-sm);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 700;" id="selectedProductName"></span>
                                    <span style="font-weight: 800; color: var(--primary-blue);" id="selectedProductPrice"></span>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label class="form-label">Quantité</label>
                                    <input type="number" id="saleQuantity" class="form-control" value="1" min="1" style="margin-bottom: 0.5rem;">
                                    <div style="font-size: 0.85rem; color: var(--secondary-gray);">
                                        Stock disponible: <span id="availableStock">0</span>
                                    </div>
                                </div>
                                <button class="btn btn-success" onclick="processManualSale()" style="width: 100%; margin-top: 1rem;">
                                    <i class="fas fa-cash-register"></i> Enregistrer la vente
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Liste des produits -->
                <div class="form-section" style="margin-bottom: 2rem;">
                    <div class="table-header">
                        <div class="table-title">Liste des produits (${state.products.length})</div>
                        <input 
                            type="text" 
                            id="productSearchAccounting" 
                            class="form-control" 
                            placeholder="Rechercher un produit..." 
                            style="max-width: 300px;"
                            oninput="filterProductsAccounting(this.value)"
                        >
                    </div>
                    
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th>Prix</th>
                                    <th>Stock</th>
                                    <th>Code-barres</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="accountingProductsTable">
                                ${state.products.map(product => `
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                <img src="${product.images[0] || 'https://via.placeholder.com/50'}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">
                                                <div>
                                                    <div style="font-weight: 700;">${product.name}</div>
                                                    <div style="font-size: 0.9rem; color: var(--secondary-gray);">${product.brand}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td style="font-weight: 800; color: var(--primary-blue);">${formatPrice(product.price)}</td>
                                        <td>
                                            <span class="badge" style="background: ${product.stock > 10 ? '#28a745' : product.stock > 0 ? '#ffc107' : '#dc3545'}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px;">
                                                ${product.stock} unités
                                            </span>
                                        </td>
                                        <td style="font-family: monospace; color: var(--secondary-gray);">
                                            ${product.barcode || product.id.toString().padStart(8, '0')}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="sellProduct(${product.id})" ${product.stock === 0 ? 'disabled' : ''}>
                                                <i class="fas fa-cash-register"></i> Vendre
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Ventes récentes -->
                <div class="form-section">
                    <div class="table-header">
                        <div class="table-title">Ventes d'aujourd'hui (${todaySalesFiltered.length})</div>
                        <button class="btn btn-primary" onclick="showSalesReports()">
                            <i class="fas fa-chart-bar"></i> Voir les rapports
                        </button>
                    </div>
                    
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Heure</th>
                                    <th>Produit</th>
                                    <th>Quantité</th>
                                    <th>Prix unitaire</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="todaySalesTable">
                                ${todaySalesFiltered.length > 0 ? todaySalesFiltered.slice().reverse().map(sale => `
                                    <tr>
                                        <td>${new Date(sale.date).toLocaleTimeString()}</td>
                                        <td>${sale.productName}</td>
                                        <td>${sale.quantity}</td>
                                        <td>${formatPrice(sale.unitPrice)}</td>
                                        <td style="font-weight: 800; color: var(--primary-blue);">${formatPrice(sale.total)}</td>
                                    </tr>
                                `).join('') : `
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--secondary-gray);">
                                            <i class="fas fa-shopping-bag" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem; display: block;"></i>
                                            Aucune vente aujourd'hui
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // ===== ANALYTIQUES =====
        function getAnalyticsContent() {
            const totalRevenue = state.orders.reduce((sum, order) => sum + order.total, 0);
            const pendingOrders = state.orders.filter(order => order.status === 'pending').length;
            const lowStockProducts = state.products.filter(product => product.stock < 10).length;
            const revenueData = [120000, 150000, 180000, 220000, 190000, 250000, 280000];
            const orderData = [12, 18, 15, 22, 19, 25, 30];
            
            return `
                <!-- Statistiques principales -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Produits</div>
                            <div class="stat-icon">
                                <i class="fas fa-box"></i>
                            </div>
                        </div>
                        <div class="stat-value">${state.products.length}</div>
                        <div class="stat-change">
                            <i class="fas fa-exclamation-triangle" style="color: ${lowStockProducts > 0 ? '#ffc107' : '#28a745'}"></i>
                            ${lowStockProducts} en stock faible
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Commandes</div>
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                        </div>
                        <div class="stat-value">${state.orders.length}</div>
                        <div class="stat-change">
                            <i class="fas fa-clock" style="color: ${pendingOrders > 0 ? '#ffc107' : '#28a745'}"></i>
                            ${pendingOrders} en attente
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Revenus</div>
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                        </div>
                        <div class="stat-value">${formatPrice(totalRevenue)}</div>
                        <div class="stat-change">
                            <i class="fas fa-chart-line" style="color: #28a745"></i>
                            Total des ventes
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Clients</div>
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value">${state.customers.length}</div>
                        <div class="stat-change">
                            <i class="fas fa-user-plus" style="color: #28a745"></i>
                            Clients actifs
                        </div>
                    </div>
                </div>
                
                <!-- Statistiques supplémentaires -->
                <div class="stats-grid" style="margin-top: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Ventes ce mois</div>
                            <div class="stat-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                        </div>
                        <div class="stat-value">${formatPrice(280000)}</div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up" style="color: #28a745"></i>
                            +15% vs mois dernier
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Commandes ce mois</div>
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                        </div>
                        <div class="stat-value">30</div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up" style="color: #28a745"></i>
                            +8% vs mois dernier
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Panier moyen</div>
                            <div class="stat-icon">
                                <i class="fas fa-shopping-basket"></i>
                            </div>
                        </div>
                        <div class="stat-value">${formatPrice(93333)}</div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up" style="color: #28a745"></i>
                            +12% vs mois dernier
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Taux de conversion</div>
                            <div class="stat-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                        </div>
                        <div class="stat-value">3.2%</div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up" style="color: #28a745"></i>
                            +0.5% vs mois dernier
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 style="margin-bottom: 2rem; color: var(--primary-blue); display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-chart-line"></i>
                        <span>Performances des ventes</span>
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4 style="margin-bottom: 1rem; font-size: 1.1rem; color: var(--primary-black);">Revenus (derniers 7 jours)</h4>
                            <canvas id="revenueChart" style="width: 100%; height: 300px;"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 1rem; font-size: 1.1rem; color: var(--primary-black);">Commandes (derniers 7 jours)</h4>
                            <canvas id="ordersChart" style="width: 100%; height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 style="margin-bottom: 2rem; color: var(--primary-blue); display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-star"></i>
                        <span>Produits les plus populaires</span>
                    </h3>
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th>Ventes</th>
                                    <th>Revenus</th>
                                    <th>Taux de conversion</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.products.slice(0, 5).map((product, index) => `
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, var(--primary-blue), var(--accent-color)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                                                    ${index + 1}
                                                </div>
                                                <img src="${product.images[0]}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                                <div>
                                                    <div style="font-weight: 700;">${product.name}</div>
                                                    <div style="font-size: 0.9rem; color: var(--secondary-gray);">${product.category}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td style="font-weight: 700;">${Math.floor(Math.random() * 50) + 10}</td>
                                        <td style="font-weight: 800; color: var(--primary-blue);">${formatPrice(product.price * (Math.floor(Math.random() * 50) + 10))}</td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div style="width: 100px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                                    <div style="width: ${(Math.random() * 80 + 20)}%; height: 100%; background: linear-gradient(to right, var(--primary-blue), var(--accent-color));"></div>
                                                </div>
                                                <span style="font-weight: 700; color: var(--primary-black);">${(Math.random() * 5 + 1).toFixed(1)}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // ===== PARAMÈTRES =====
        function getSettingsContent() {
            return `
                <div class="form-section">
                    <h3 style="margin-bottom: 2rem; color: var(--primary-blue); display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--primary-blue), var(--accent-color)); display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-cog"></i>
                        </div>
                        <span>Paramètres de la boutique</span>
                    </h3>
                    
                    <form id="settingsForm">
                        <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Nom de la boutique</label>
                                    <input type="text" class="form-control" id="storeName" value="${state.settings.storeName}">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Numéro WhatsApp pour les commandes</label>
                                    <input type="text" class="form-control" id="whatsappNumber" value="${state.settings.whatsappNumber}" placeholder="+227XXXXXXXXX">
                                    <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-top: 0.25rem;">
                                        Les clients utiliseront ce numéro pour commander via WhatsApp
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Devise</label>
                                    <select class="form-select" id="currency">
                                        <option value="FCFA" ${state.settings.currency === 'FCFA' ? 'selected' : ''}>Franc CFA (FCFA)</option>
                                        <option value="EUR" ${state.settings.currency === 'EUR' ? 'selected' : ''}>Euro (€)</option>
                                        <option value="USD" ${state.settings.currency === 'USD' ? 'selected' : ''}>Dollar ($)</option>
                                        <option value="XOF" ${state.settings.currency === 'XOF' ? 'selected' : ''}>Franc CFA (XOF)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Email de contact</label>
                                    <input type="email" class="form-control" id="contactEmail" value="${state.settings.contactEmail || ''}" placeholder="contact@votreboutique.com">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Adresse de la boutique</label>
                                    <textarea class="form-control" id="storeAddress" rows="3">${state.settings.storeAddress || ''}</textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Lien Google Maps (emplacement)</label>
                                    <input type="url" class="form-control" id="storeLocation" value="${state.settings.storeLocation || ''}" placeholder="https://maps.google.com/?q=...">
                                    <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-top: 0.25rem;">
                                        Copiez le lien de partage depuis Google Maps
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Logo de la boutique</label>
                                    <div style="margin-bottom: 1rem;">
                                        ${state.settings.storeLogo ? `
                                            <img src="${state.settings.storeLogo}" id="logoPreview" style="max-width: 200px; max-height: 100px; border-radius: var(--border-radius-sm); border: 2px solid #e9ecef; padding: 0.5rem; background: white;">
                                        ` : `
                                            <div id="logoPreview" style="width: 200px; height: 100px; border: 2px dashed #e9ecef; border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; color: var(--secondary-gray); background: #f8f9fa;">
                                                <i class="fas fa-image" style="font-size: 2rem;"></i>
                                            </div>
                                        `}
                                    </div>
                                    <input type="url" class="form-control" id="storeLogo" value="${state.settings.storeLogo || ''}" placeholder="URL de l'image du logo" oninput="updateLogoPreview(this.value)">
                                    <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-top: 0.25rem;">
                                        Entrez l'URL de votre logo ou utilisez un service d'hébergement d'images
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Réseaux sociaux -->
                        <div class="form-section" style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e9ecef;">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary-blue); display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-share-alt"></i>
                                <span>Réseaux sociaux</span>
                            </h3>
                            <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fab fa-whatsapp" style="color: #25D366; margin-right: 0.5rem;"></i>
                                        WhatsApp
                                    </label>
                                    <input type="text" class="form-control" id="whatsappUrl" value="${state.settings.whatsappNumber || ''}" placeholder="+227XXXXXXXXX" readonly>
                                    <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-top: 0.25rem;">
                                        Utilisez le champ WhatsApp ci-dessus
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fab fa-facebook-f" style="color: #1877F2; margin-right: 0.5rem;"></i>
                                        Facebook
                                    </label>
                                    <input type="url" class="form-control" id="facebookUrl" value="${state.settings.facebookUrl || ''}" placeholder="https://facebook.com/votre-page">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fab fa-instagram" style="color: #E4405F; margin-right: 0.5rem;"></i>
                                        Instagram
                                    </label>
                                    <input type="url" class="form-control" id="instagramUrl" value="${state.settings.instagramUrl || ''}" placeholder="https://instagram.com/votre-compte">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fab fa-tiktok" style="color: #000000; margin-right: 0.5rem;"></i>
                                        TikTok
                                    </label>
                                    <input type="url" class="form-control" id="tiktokUrl" value="${state.settings.tiktokUrl || ''}" placeholder="https://tiktok.com/@votre-compte">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fab fa-linkedin-in" style="color: #0077B5; margin-right: 0.5rem;"></i>
                                        LinkedIn
                                    </label>
                                    <input type="url" class="form-control" id="linkedinUrl" value="${state.settings.linkedinUrl || ''}" placeholder="https://linkedin.com/company/votre-entreprise">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fab fa-twitter" style="color: #1DA1F2; margin-right: 0.5rem;"></i>
                                        Twitter (X)
                                    </label>
                                    <input type="url" class="form-control" id="twitterUrl" value="${state.settings.twitterUrl || ''}" placeholder="https://twitter.com/votre-compte">
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius-sm);">
                                <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                                Ces liens seront affichés sur le site public et permettront aux visiteurs de vous suivre sur vos réseaux sociaux.
                            </div>
                        </div>
                        
                        <div class="d-flex gap-3" style="margin-top: 2rem;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Enregistrer les paramètres
                            </button>
                            <button type="button" class="btn" style="background: #e9ecef;" onclick="resetSettings()">
                                <i class="fas fa-undo"></i> Réinitialiser
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }
        
        // ===== FONCTIONS UTILITAIRES =====
        function formatPrice(price) {
            return new Intl.NumberFormat('fr-FR').format(price) + ' ' + state.settings.currency;
        }
        
        // ===== MODALS PERSONNALISÉS =====
        function showCustomConfirm(message, onConfirm, onCancel) {
            // Créer un ID unique pour stocker les callbacks
            const callbackId = 'confirm_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Stocker les callbacks dans un objet global
            if (!window._confirmCallbacks) {
                window._confirmCallbacks = {};
            }
            window._confirmCallbacks[callbackId] = { onConfirm, onCancel };
            
            const modalHTML = `
                <div class="modal-overlay" id="confirmModal_${callbackId}" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;" onclick="if(event.target === this) { const modal = document.getElementById('confirmModal_${callbackId}'); if(window._confirmCallbacks && window._confirmCallbacks['${callbackId}'] && window._confirmCallbacks['${callbackId}'].onCancel) window._confirmCallbacks['${callbackId}'].onCancel(); modal.remove(); delete window._confirmCallbacks['${callbackId}']; }">
                    <div style="background: white; border-radius: var(--border-radius); width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease;" onclick="event.stopPropagation();">
                        <div style="padding: 2rem;">
                            <div style="text-align: center; margin-bottom: 2rem;">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: rgba(220, 53, 69, 0.1); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--danger-color);"></i>
                                </div>
                                <h3 style="color: var(--primary-black); margin-bottom: 0.5rem;">Confirmation</h3>
                                <p style="color: var(--secondary-gray); line-height: 1.6;">${message}</p>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn" onclick="const modal = document.getElementById('confirmModal_${callbackId}'); if(window._confirmCallbacks && window._confirmCallbacks['${callbackId}'] && window._confirmCallbacks['${callbackId}'].onCancel) window._confirmCallbacks['${callbackId}'].onCancel(); modal.remove(); delete window._confirmCallbacks['${callbackId}'];" style="flex: 1; background: #e9ecef;">
                                    Annuler
                                </button>
                                <button class="btn btn-primary" onclick="const modal = document.getElementById('confirmModal_${callbackId}'); if(window._confirmCallbacks && window._confirmCallbacks['${callbackId}'] && window._confirmCallbacks['${callbackId}'].onConfirm) window._confirmCallbacks['${callbackId}'].onConfirm(); modal.remove(); delete window._confirmCallbacks['${callbackId}'];" style="flex: 1;">
                                    Confirmer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function showCustomPrompt(title, placeholder, onConfirm, onCancel) {
            // Créer un ID unique pour stocker les callbacks
            const callbackId = 'prompt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Stocker les callbacks dans un objet global
            if (!window._promptCallbacks) {
                window._promptCallbacks = {};
            }
            window._promptCallbacks[callbackId] = { onConfirm, onCancel };
            
            const modalHTML = `
                <div class="modal-overlay" id="promptModal_${callbackId}" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;" onclick="if(event.target === this) { const modal = document.getElementById('promptModal_${callbackId}'); if(window._promptCallbacks && window._promptCallbacks['${callbackId}'] && window._promptCallbacks['${callbackId}'].onCancel) window._promptCallbacks['${callbackId}'].onCancel(); modal.remove(); delete window._promptCallbacks['${callbackId}']; }">
                    <div style="background: white; border-radius: var(--border-radius); width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease;" onclick="event.stopPropagation();">
                        <div style="padding: 2rem;">
                            <h3 style="color: var(--primary-blue); margin-bottom: 1rem; text-align: center;">${title}</h3>
                            <div class="form-group">
                                <input type="text" id="customPromptInput_${callbackId}" class="form-control" placeholder="${placeholder}" style="margin-bottom: 1.5rem;" autofocus onkeypress="if(event.key === 'Enter') { const input = document.getElementById('customPromptInput_${callbackId}'); const modal = document.getElementById('promptModal_${callbackId}'); if(window._promptCallbacks && window._promptCallbacks['${callbackId}'] && window._promptCallbacks['${callbackId}'].onConfirm && input.value.trim()) { window._promptCallbacks['${callbackId}'].onConfirm(input.value.trim()); modal.remove(); delete window._promptCallbacks['${callbackId}']; } }">
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn" onclick="const modal = document.getElementById('promptModal_${callbackId}'); if(window._promptCallbacks && window._promptCallbacks['${callbackId}'] && window._promptCallbacks['${callbackId}'].onCancel) window._promptCallbacks['${callbackId}'].onCancel(); modal.remove(); delete window._promptCallbacks['${callbackId}'];" style="flex: 1; background: #e9ecef;">
                                    Annuler
                                </button>
                                <button class="btn btn-primary" onclick="const input = document.getElementById('customPromptInput_${callbackId}'); const modal = document.getElementById('promptModal_${callbackId}'); if(window._promptCallbacks && window._promptCallbacks['${callbackId}'] && window._promptCallbacks['${callbackId}'].onConfirm && input.value.trim()) { window._promptCallbacks['${callbackId}'].onConfirm(input.value.trim()); modal.remove(); delete window._promptCallbacks['${callbackId}']; }" style="flex: 1;">
                                    Valider
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Focus sur l'input après un court délai
            setTimeout(() => {
                const input = document.getElementById(`customPromptInput_${callbackId}`);
                if (input) input.focus();
            }, 100);
            setTimeout(() => document.getElementById('customPromptInput')?.focus(), 100);
        }
        
        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}"></i>
                </div>
                <div>
                    <div style="font-weight: 700;">${title}</div>
                    <div style="font-size: 0.9rem; color: var(--secondary-gray);">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function editProduct(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            state.currentProduct = product;
            showPage('add-product');
            
            // Remplir le formulaire après un court délai
            setTimeout(() => {
                if (document.getElementById('productName')) {
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productBrand').value = product.brand;
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productDescription').value = product.description;
                    document.getElementById('productTags').value = product.tags.join(', ');
                    document.getElementById('productPromotion').value = product.promotionId || '';
                    
                    // Mettre à jour le titre de la page
                    document.querySelector('#pageContent h3 span').textContent = 'Modifier le produit';
                }
            }, 100);
        }
        
        async function deleteProduct(productId) {
            showCustomConfirm('Êtes-vous sûr de vouloir supprimer ce produit ? Cette action est irréversible. Le produit disparaîtra également du site utilisateur.', async () => {
                try {
                    // Supprimer de Supabase si activé
                    if (USE_SUPABASE && supabase) {
                        // Supprimer d'abord les images associées
                        const { error: imagesError } = await supabase
                            .from('product_images')
                            .delete()
                            .eq('product_id', productId);
                        
                        if (imagesError) {
                            console.error('Erreur suppression images:', imagesError);
                        }
                        
                        // Supprimer les références dans order_items (si existantes)
                        const { error: orderItemsError } = await supabase
                            .from('order_items')
                            .delete()
                            .eq('product_id', productId);
                        
                        if (orderItemsError) {
                            console.error('Erreur suppression order_items:', orderItemsError);
                        }
                        
                        // Supprimer les références dans sales (si existantes)
                        const { error: salesError } = await supabase
                            .from('sales')
                            .delete()
                            .eq('product_id', productId);
                        
                        if (salesError) {
                            console.error('Erreur suppression sales:', salesError);
                        }
                        
                        // Supprimer le produit
                        const { data: deletedData, error: productError } = await supabase
                            .from('products')
                            .delete()
                            .eq('id', productId)
                            .select();
                        
                        if (productError) {
                            console.error('❌ Erreur suppression produit:', productError);
                            console.error('Détails erreur:', JSON.stringify(productError, null, 2));
                            showToast('Erreur', 'Erreur lors de la suppression: ' + (productError.message || 'Erreur inconnue'), 'error');
                            return;
                        }
                        
                        // Vérifier que le produit a bien été supprimé
                        if (!deletedData || deletedData.length === 0) {
                            console.warn('⚠️ Aucun produit supprimé - peut-être qu\'il n\'existe pas');
                            showToast('Avertissement', 'Le produit n\'a pas été trouvé dans la base de données', 'error');
                            return;
                        }
                        
                        console.log('✅ Produit supprimé de Supabase:', deletedData);
                        
                        // Vérifier une seconde fois que le produit n'existe plus
                        const { data: checkData } = await supabase
                            .from('products')
                            .select('id')
                            .eq('id', productId)
                            .maybeSingle();
                        
                        if (checkData) {
                            console.error('❌ Le produit existe encore après suppression !');
                            showToast('Erreur', 'La suppression a échoué. Le produit existe encore.', 'error');
                            return;
                        }
                        
                        console.log('✅ Vérification: Le produit a bien été supprimé de la base de données');
                    }
                    
                    // Supprimer du state local immédiatement
                state.products = state.products.filter(p => p.id !== productId);
                    
                    // Sauvegarder dans localStorage (fallback)
                    localStorage.setItem('targui_products', JSON.stringify(state.products));
                    
                    // Mettre à jour l'interface immédiatement
                updateCounters();
                showToast('Succès', 'Produit supprimé avec succès!', 'success');
                showPage('dashboard');
                    
                    // Recharger depuis Supabase après un court délai pour vérifier
                    setTimeout(async () => {
                        if (USE_SUPABASE && supabase) {
                            await loadFromSupabase();
                            updateCounters();
                            showPage('dashboard');
                        }
                    }, 300);
                } catch (error) {
                    console.error('Erreur lors de la suppression:', error);
                    showToast('Erreur', 'Erreur lors de la suppression du produit', 'error');
                }
            });
        }
        
        function shareProduct(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            const message = encodeURIComponent(
                `🛍️ *${product.name}*\n\n` +
                `💰 Prix: ${formatPrice(product.price)}\n` +
                `📱 Marque: ${product.brand}\n` +
                `📦 Catégorie: ${product.category}\n\n` +
                `${product.description || ''}\n\n` +
                `Pour commander, contactez-nous sur WhatsApp: ${state.settings.whatsappNumber}`
            );
            
            const whatsappUrl = `https://wa.me/?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }
        
        function deletePromotion(promoId) {
            showCustomConfirm('Êtes-vous sûr de vouloir supprimer cette promotion ?', () => {
                state.promotions = state.promotions.filter(p => p.id !== promoId);
                savePromotions();
                updateCounters();
                showToast('Succès', 'Promotion supprimée avec succès!', 'success');
                showPage('promotions');
            });
        }
        
        function viewOrder(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;
            
            const itemsList = order.items.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f8f9fa; border-radius: var(--border-radius-sm); margin-bottom: 0.5rem;">
                    <div>
                        <div style="font-weight: 700;">${item.name}</div>
                        <div style="font-size: 0.85rem; color: var(--secondary-gray);">Quantité: ${item.quantity || 1}</div>
                    </div>
                    <div style="font-weight: 800; color: var(--primary-blue);">${formatPrice(item.price * (item.quantity || 1))}</div>
                </div>
            `).join('');
            
            const modalHTML = `
                <div class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;" onclick="if(event.target === this) closeModal();">
                    <div style="background: white; border-radius: var(--border-radius); width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation();">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--primary-blue); margin: 0;">
                                <i class="fas fa-shopping-bag"></i> Commande #${order.id}
                            </h3>
                            <button type="button" onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; color: var(--secondary-gray); cursor: pointer;">×</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="margin-bottom: 1.5rem;">
                                <div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--primary-black);">👤 Client</div>
                                <div style="padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius-sm);">
                                    <div style="font-weight: 600;">${order.customer?.name || 'Non spécifié'}</div>
                                    <div style="font-size: 0.9rem; color: var(--secondary-gray); margin-top: 0.25rem;">
                                        📞 ${order.customer?.phone || 'Non spécifié'}<br>
                                        📧 ${order.customer?.email || 'Non spécifié'}
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 1.5rem;">
                                <div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--primary-black);">🛒 Produits</div>
                                ${itemsList}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius-sm);">
                                    <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-bottom: 0.25rem;">Statut</div>
                                    <div style="font-weight: 700; color: var(--primary-blue);">${getStatusText(order.status)}</div>
                                </div>
                                <div style="padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius-sm);">
                                    <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-bottom: 0.25rem;">Date</div>
                                    <div style="font-weight: 700; color: var(--primary-black);">${new Date(order.date).toLocaleString()}</div>
                                </div>
                            </div>
                            <div style="padding: 1.5rem; background: linear-gradient(135deg, var(--primary-blue), var(--accent-color)); border-radius: var(--border-radius-sm); color: white; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Total</div>
                                <div style="font-size: 2rem; font-weight: 800;">${formatPrice(order.total)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function contactCustomer(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order || !order.customer?.phone) {
                showToast('Erreur', 'Numéro de téléphone non disponible', 'error');
                return;
            }
            
            const message = encodeURIComponent(
                `Bonjour ${order.customer.name},\n\n` +
                `Concernant votre commande #${order.id} sur TARGUI STORE.\n` +
                `Statut: ${getStatusText(order.status)}\n` +
                `Total: ${formatPrice(order.total)}\n\n` +
                `Comment pouvons-nous vous aider ?`
            );
            
            const whatsappUrl = `https://wa.me/${order.customer.phone.replace('+', '')}?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }
        
        function getStatusColor(status) {
            const colors = {
                'pending': '#ffc107',
                'processing': '#17a2b8',
                'shipped': '#007bff',
                'delivered': '#28a745',
                'cancelled': '#dc3545'
            };
            return colors[status] || '#6c757d';
        }
        
        function getStatusText(status) {
            const texts = {
                'pending': 'En attente',
                'processing': 'En traitement',
                'shipped': 'Expédiée',
                'delivered': 'Livrée',
                'cancelled': 'Annulée'
            };
            return texts[status] || status;
        }
        
        function updateImageCount() {
            const countEl = document.getElementById('imageCount');
            if (countEl) {
                const currentCount = document.querySelectorAll('#imagePreviewGrid .image-preview').length;
                countEl.textContent = `${currentCount} / 10 photos`;
                if (currentCount >= 10) {
                    countEl.style.color = 'var(--danger-color)';
                    document.getElementById('imageUploadArea').style.opacity = '0.5';
                    document.getElementById('imageUploadArea').style.pointerEvents = 'none';
                } else {
                    countEl.style.color = 'var(--primary-blue)';
                    document.getElementById('imageUploadArea').style.opacity = '1';
                    document.getElementById('imageUploadArea').style.pointerEvents = 'auto';
                }
            }
            updateProductPreview();
        }
        
        // ===== PRÉVISUALISATION EN TEMPS RÉEL =====
        function generateProductPreview() {
            const name = document.getElementById('productName')?.value || '';
            const brand = document.getElementById('productBrand')?.value || '';
            const category = document.getElementById('productCategory')?.value || '';
            const price = document.getElementById('productPrice')?.value || '0';
            const stock = document.getElementById('productStock')?.value || '0';
            const description = document.getElementById('productDescription')?.value || '';
            
            // Récupérer les images
            const imagePreviews = document.querySelectorAll('#imagePreviewGrid .image-preview img');
            const images = Array.from(imagePreviews).map(img => img.src);
            const imageUrl = document.getElementById('imageUrl')?.value;
            if (imageUrl && images.length < 10) {
                images.push(imageUrl);
            }
            
            // Si aucun champ n'est rempli, afficher le message par défaut
            if (!name && !brand && !category && images.length === 0) {
                return `
                    <div style="text-align: center; padding: 3rem 2rem; color: var(--secondary-gray);">
                        <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="margin: 0;">Commencez à remplir le formulaire pour voir l'aperçu</p>
                    </div>
                `;
            }
            
            const stockNum = parseInt(stock) || 0;
            const priceNum = parseInt(price) || 0;
            
            return `
                <div class="product-preview-card" style="background: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-sm); transition: var(--transition);">
                    <!-- Image principale -->
                    <div style="position: relative; overflow: hidden; background: #f8f9fa;">
                        ${images.length > 0 ? `
                            <div style="position: relative;">
                                <img src="${images[0]}" alt="${name || 'Produit'}" style="width: 100%; height: 250px; object-fit: cover; display: block;">
                                ${images.length > 1 ? `
                                    <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                                        +${images.length - 1} photo${images.length > 2 ? 's' : ''}
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div style="width: 100%; height: 250px; background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%); display: flex; align-items: center; justify-content: center; color: var(--secondary-gray);">
                                <i class="fas fa-image" style="font-size: 3rem; opacity: 0.3;"></i>
                            </div>
                        `}
                        
                        ${stockNum < 10 && stockNum > 0 ? `
                            <div style="position: absolute; top: 10px; left: 10px; background: var(--warning-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                Stock faible
                            </div>
                        ` : ''}
                        ${stockNum === 0 ? `
                            <div style="position: absolute; top: 10px; left: 10px; background: var(--danger-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                Rupture
                            </div>
                        ` : ''}
                        
                        <div style="position: absolute; top: 10px; right: 10px;">
                            <button style="background: rgba(255,255,255,0.9); color: #666; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; transition: var(--transition);" onmouseover="this.style.background='#ff4757'; this.style.color='white';" onmouseout="this.style.background='rgba(255,255,255,0.9)'; this.style.color='#666';">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Informations du produit -->
                    <div style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                            ${category || 'Catégorie'} ${brand ? '• ' + brand : ''}
                        </div>
                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--primary-black); line-height: 1.4; min-height: 2.8rem;">
                            ${name || 'Nom du produit'}
                        </div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: var(--primary-blue); margin-bottom: 1rem;">
                            ${priceNum > 0 ? formatPrice(priceNum) : '0 FCFA'}
                        </div>
                        
                        ${description ? `
                            <div style="margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                                <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-bottom: 0.5rem; font-weight: 600;">Description:</div>
                                <div style="font-size: 0.9rem; color: var(--primary-black); line-height: 1.6; max-height: 100px; overflow-y: auto;">
                                    ${description}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Galerie d'images (si plusieurs) -->
                        ${images.length > 1 ? `
                            <div style="margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                                <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-bottom: 0.75rem; font-weight: 600;">Galerie (${images.length} photos):</div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                                    ${images.slice(0, 4).map(img => `
                                        <img src="${img}" style="width: 100%; height: 60px; object-fit: cover; border-radius: var(--border-radius-sm); border: 2px solid #e9ecef;">
                                    `).join('')}
                                    ${images.length > 4 ? `
                                        <div style="width: 100%; height: 60px; background: rgba(0, 86, 210, 0.1); border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; color: var(--primary-blue); font-weight: 700; font-size: 0.85rem;">
                                            +${images.length - 4}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                            <button style="flex: 1; min-width: 120px; background: var(--primary-blue); color: white; border: none; padding: 0.75rem 1rem; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600; transition: var(--transition); box-shadow: var(--shadow-sm);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)';" ${stockNum === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                <i class="fas fa-cart-plus"></i> Ajouter
                            </button>
                            <button style="flex: 1; min-width: 120px; background: #e9ecef; color: var(--primary-black); border: none; padding: 0.75rem 1rem; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600; transition: var(--transition);" onmouseover="this.style.background='#dee2e6';" onmouseout="this.style.background='#e9ecef';">
                                <i class="fas fa-eye"></i> Voir
                            </button>
                        </div>
                        
                        <!-- Stock -->
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.85rem; color: var(--secondary-gray);">Stock disponible:</span>
                            <span style="font-weight: 700; color: ${stockNum > 10 ? 'var(--success-color)' : stockNum > 0 ? 'var(--warning-color)' : 'var(--danger-color)'};">
                                ${stockNum} unité${stockNum > 1 ? 's' : ''}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateProductPreview() {
            const previewContainer = document.getElementById('productPreview');
            if (previewContainer) {
                previewContainer.innerHTML = generateProductPreview();
            }
        }
        
        function initProductPreview() {
            // Event listeners pour tous les champs
            const fields = ['productName', 'productBrand', 'productCategory', 'productPrice', 'productStock', 'productDescription', 'imageUrl'];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateProductPreview);
                    field.addEventListener('change', updateProductPreview);
                }
            });
            
            // Observer pour les images ajoutées
            const imageGrid = document.getElementById('imagePreviewGrid');
            if (imageGrid) {
                const observer = new MutationObserver(() => {
                    updateProductPreview();
                });
                observer.observe(imageGrid, { childList: true, subtree: true });
            }
            
            // Initialiser la prévisualisation
            setTimeout(updateProductPreview, 100);
        }
        
        function togglePreviewPanel() {
            const previewPanel = document.getElementById('previewPanel');
            const formContainer = document.getElementById('formPreviewContainer');
            const toggleBtn = document.getElementById('togglePreviewBtn');
            const previewIcon = document.getElementById('previewIcon');
            const previewBtnText = document.getElementById('previewBtnText');
            
            if (previewPanel && formContainer) {
                const isVisible = previewPanel.style.display !== 'none' && previewPanel.style.display !== '';
                
                if (isVisible) {
                    previewPanel.style.display = 'none';
                    formContainer.style.gridTemplateColumns = '1fr';
                    if (previewIcon) previewIcon.className = 'fas fa-eye';
                    if (previewBtnText) previewBtnText.textContent = 'Aperçu en direct';
                } else {
                    previewPanel.style.display = 'block';
                    formContainer.style.gridTemplateColumns = '1fr 450px';
                    if (previewIcon) previewIcon.className = 'fas fa-eye-slash';
                    if (previewBtnText) previewBtnText.textContent = 'Masquer aperçu';
                }
            }
        }
        
        // ===== COMPRESSION D'IMAGES EN BASE64 =====
        /**
         * Compresse une image et la convertit en base64
         * @param {File} file - Le fichier image à compresser
         * @param {number} maxWidth - Largeur maximale (défaut: 800px)
         * @param {number} maxHeight - Hauteur maximale (défaut: 800px)
         * @param {number} quality - Qualité JPEG (0.1 à 1.0, défaut: 0.6)
         * @param {number} maxSizeKB - Taille maximale en KB (défaut: 100KB)
         * @returns {Promise<string>} - Promise qui résout avec le base64 compressé
         */
        async function compressImageToBase64(file, maxWidth = 800, maxHeight = 800, quality = 0.6, maxSizeKB = 100) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    
                    img.onload = function() {
                        // Calculer les nouvelles dimensions en gardant le ratio
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth || height > maxHeight) {
                            if (width > height) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            } else {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        // Créer un canvas pour redimensionner et compresser
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        // Dessiner l'image redimensionnée
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convertir en base64 avec compression
                        let base64 = canvas.toDataURL('image/jpeg', quality);
                        let currentSizeKB = (base64.length * 3) / 4 / 1024;
                        
                        // Si l'image est encore trop grande, réduire la qualité
                        if (currentSizeKB > maxSizeKB) {
                            let currentQuality = quality;
                            while (currentSizeKB > maxSizeKB && currentQuality > 0.1) {
                                currentQuality -= 0.1;
                                base64 = canvas.toDataURL('image/jpeg', currentQuality);
                                currentSizeKB = (base64.length * 3) / 4 / 1024;
                            }
                        }
                        
                        resolve(base64);
                    };
                    
                    img.onerror = function() {
                        reject(new Error('Erreur lors du chargement de l\'image'));
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.onerror = function() {
                    reject(new Error('Erreur lors de la lecture du fichier'));
                };
                
                reader.readAsDataURL(file);
                        });
        }
        
        function initImageUpload() {
            const uploadArea = document.getElementById('imageUploadArea');
            const uploadInput = document.getElementById('imageUploadInput');
            const previewGrid = document.getElementById('imagePreviewGrid');
            
            if (!uploadArea || !uploadInput) return;
            
            uploadArea.addEventListener('click', () => {
                const currentCount = document.querySelectorAll('#imagePreviewGrid .image-preview').length;
                if (currentCount >= 10) {
                    showToast('Erreur', 'Vous avez atteint la limite de 10 photos', 'error');
                    return;
                }
                uploadInput.click();
            });
            
            uploadInput.addEventListener('change', function(e) {
                const currentCount = document.querySelectorAll('#imagePreviewGrid .image-preview').length;
                const files = Array.from(e.target.files);
                const remainingSlots = 10 - currentCount;
                
                if (files.length > remainingSlots) {
                    showToast('Erreur', `Vous ne pouvez ajouter que ${remainingSlots} photo(s) de plus (maximum 10)`, 'error');
                    files.splice(remainingSlots);
                }
                
                files.forEach(file => {
                    if (currentCount >= 10) {
                        showToast('Erreur', 'Limite de 10 photos atteinte', 'error');
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        showToast('Erreur', 'L\'image ne doit pas dépasser 5MB', 'error');
                        return;
                    }
                    
                    // Afficher un indicateur de chargement
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'image-preview';
                    loadingDiv.style.position = 'relative';
                    loadingDiv.innerHTML = `
                        <div style="width: 100%; height: 120px; display: flex; align-items: center; justify-content: center; background: #f0f0f0; border-radius: var(--border-radius-sm);">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-blue);"></i>
                        </div>
                    `;
                    previewGrid.appendChild(loadingDiv);
                    
                    // Compresser et convertir en base64 (max 100KB)
                    compressImageToBase64(file, 800, 800, 0.6, 100)
                        .then(base64 => {
                            // Remplacer le loader par l'image compressée
                            loadingDiv.innerHTML = `
                                <img src="${base64}" style="width: 100%; height: 120px; object-fit: cover; border-radius: var(--border-radius-sm);">
                            <button type="button" class="remove-image" onclick="this.parentElement.remove(); updateImageCount(); updateProductPreview();" style="position: absolute; top: 5px; right: 5px; background: var(--danger-color); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        updateImageCount();
                        updateProductPreview();
                        })
                        .catch(error => {
                            loadingDiv.remove();
                            showToast('Erreur', 'Erreur lors de la compression de l\'image: ' + error.message, 'error');
                        });
                });
                
                uploadInput.value = '';
            });
            
            // Drag and drop pour images
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                const currentCount = document.querySelectorAll('#imagePreviewGrid .image-preview').length;
                if (currentCount < 10) {
                uploadArea.style.borderColor = 'var(--primary-blue)';
                uploadArea.style.background = 'rgba(0, 86, 210, 0.05)';
                }
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#e9ecef';
                uploadArea.style.background = 'transparent';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#e9ecef';
                uploadArea.style.background = 'transparent';
                
                if (e.dataTransfer.files.length) {
                    const imageFiles = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                    if (imageFiles.length > 0) {
                        const currentCount = document.querySelectorAll('#imagePreviewGrid .image-preview').length;
                        const remainingSlots = 10 - currentCount;
                        if (imageFiles.length > remainingSlots) {
                            showToast('Erreur', `Vous ne pouvez ajouter que ${remainingSlots} photo(s) de plus`, 'error');
                            imageFiles.splice(remainingSlots);
                        }
                        const dataTransfer = new DataTransfer();
                        imageFiles.forEach(file => dataTransfer.items.add(file));
                        uploadInput.files = dataTransfer.files;
                    uploadInput.dispatchEvent(new Event('change'));
                    }
                }
            });
            
            updateImageCount();
        }
        
        async function handleAddProduct(e) {
            e.preventDefault();
            
            // Récupérer les images
            const imagePreviews = document.querySelectorAll('#imagePreviewGrid .image-preview img');
            const images = Array.from(imagePreviews).map(img => img.src);
            
            // Ajouter l'URL d'image si fournie
            const imageUrl = document.getElementById('imageUrl');
            if (imageUrl && imageUrl.value) {
                if (images.length < 10) {
                    images.push(imageUrl.value);
                } else {
                    showToast('Erreur', 'Limite de 10 photos atteinte', 'error');
                    return;
                }
            }
            
            if (images.length === 0) {
                showToast('Erreur', 'Veuillez ajouter au moins une image', 'error');
                return;
            }
            
            if (images.length > 10) {
                showToast('Erreur', 'Maximum 10 photos autorisées', 'error');
                return;
            }
            
            // Créer ou mettre à jour le produit
            const productData = {
                id: state.currentProduct ? state.currentProduct.id : Date.now(),
                name: document.getElementById('productName').value,
                brand: document.getElementById('productBrand').value,
                category: document.getElementById('productCategory').value,
                price: parseInt(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                description: document.getElementById('productDescription').value,
                promotionId: document.getElementById('productPromotion').value || null,
                tags: document.getElementById('productTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                images: images,
                updatedAt: new Date().toISOString()
            };
            
            if (state.currentProduct) {
                // Mettre à jour le produit existant
                const index = state.products.findIndex(p => p.id === state.currentProduct.id);
                productData.createdAt = state.currentProduct.createdAt;
                state.products[index] = productData;
                showToast('Succès', 'Produit mis à jour avec succès!', 'success');
            } else {
                // Ajouter un nouveau produit
                productData.createdAt = new Date().toISOString();
                state.products.push(productData);
                showToast('Succès', 'Produit ajouté avec succès!', 'success');
            }
            
            await saveProducts();
            updateCounters();
            state.currentProduct = null;
            
            // Rediriger vers la boutique
            setTimeout(() => showPage('dashboard'), 1000);
        }
        
        function updateStoreName() {
            const storeName = state.settings.storeName || 'TARGUI STORE';
            
            // Mettre à jour dans le logo
            const logoName = document.getElementById('storeNameLogo');
            if (logoName) {
                logoName.textContent = storeName;
            }
            
            // Mettre à jour dans le header
            const headerName = document.getElementById('storeNameHeader');
            if (headerName) {
                headerName.textContent = storeName;
            }
            
            // Mettre à jour le logo de la sidebar
            const logoImg = document.querySelector('.logo-img img');
            if (logoImg && state.settings.storeLogo) {
                logoImg.src = state.settings.storeLogo;
            }
            
            // Mettre à jour le titre de la page
            document.title = `${storeName} - Dashboard Admin`;
        }
        
        function animateStoreName() {
            const logoName = document.getElementById('storeNameLogo');
            if (logoName) {
                // Ajouter une classe d'animation temporaire
                logoName.style.animation = 'none';
                setTimeout(() => {
                    logoName.style.animation = 'storeNamePulse 1s ease-in-out, storeNameGlow 5s ease-in-out infinite';
                }, 10);
            }
        }
        
        function handleSettingsSave(e) {
            e.preventDefault();
            
            state.settings = {
                storeName: document.getElementById('storeName').value,
                whatsappNumber: document.getElementById('whatsappNumber').value,
                currency: document.getElementById('currency').value,
                contactEmail: document.getElementById('contactEmail').value,
                storeAddress: document.getElementById('storeAddress').value,
                storeLocation: document.getElementById('storeLocation').value,
                storeLogo: document.getElementById('storeLogo').value,
                facebookUrl: document.getElementById('facebookUrl').value,
                instagramUrl: document.getElementById('instagramUrl').value,
                tiktokUrl: document.getElementById('tiktokUrl').value,
                linkedinUrl: document.getElementById('linkedinUrl').value,
                twitterUrl: document.getElementById('twitterUrl').value
            };
            
            saveSettings();
            updateStoreName(); // Mettre à jour le nom partout
            showToast('Succès', 'Paramètres enregistrés avec succès!', 'success');
        }
        
        
        function resetSettings() {
            showCustomConfirm('Êtes-vous sûr de vouloir réinitialiser tous les paramètres ?', () => {
                state.settings = {
                    whatsappNumber: "",
                    currency: "FCFA",
                    storeName: "",
                    contactEmail: "",
                    storeAddress: "",
                    storeLocation: "",
                    storeLogo: "",
                    facebookUrl: "",
                    instagramUrl: "",
                    tiktokUrl: "",
                    linkedinUrl: "",
                    twitterUrl: ""
                };
                saveSettings();
                showToast('Succès', 'Paramètres réinitialisés', 'success');
                showPage('settings');
            });
        }
        
        function initCharts() {
            // Graphique des revenus
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                new Chart(revenueCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                        datasets: [{
                            label: 'Revenus',
                            data: [120000, 150000, 180000, 220000, 190000, 250000, 280000],
                            borderColor: '#0056D2',
                            backgroundColor: 'rgba(0, 86, 210, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return formatPrice(context.raw);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return formatPrice(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Graphique des commandes
            const ordersCtx = document.getElementById('ordersChart');
            if (ordersCtx) {
                new Chart(ordersCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                        datasets: [{
                            label: 'Commandes',
                            data: [12, 18, 15, 22, 19, 25, 30],
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: '#28a745',
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }
        
        function updateCounters() {
            // Mettre à jour les badges dans la navigation
            const cartCountEl = document.getElementById('cartCount');
            if (cartCountEl) cartCountEl.textContent = state.cart.length;
            const customersCountEl = document.getElementById('customersCount');
            if (customersCountEl) customersCountEl.textContent = state.customers.length;
        }
        
        function showAddPromotionModal() {
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;">
                    <div style="background: white; border-radius: var(--border-radius); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--primary-blue); margin: 0;">Nouvelle promotion</h3>
                            <button type="button" onclick="this.closest('[style]').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--secondary-gray); cursor: pointer;">×</button>
                        </div>
                        
                        <div style="padding: 1.5rem;">
                            <form id="addPromotionForm">
                                <div class="form-group">
                                    <label class="form-label">Nom de la promotion *</label>
                                    <input type="text" class="form-control" id="promotionName" placeholder="Ex: Soldes d'été" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Réduction (%) *</label>
                                    <input type="number" class="form-control" id="promotionDiscount" min="1" max="100" placeholder="20" required>
                                </div>
                                
                                <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div class="form-group">
                                        <label class="form-label">Date de début *</label>
                                        <input type="date" class="form-control" id="promotionStartDate" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Date de fin *</label>
                                        <input type="date" class="form-control" id="promotionEndDate" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Produits concernés (optionnel)</label>
                                    <select class="form-select" id="promotionProducts" multiple style="height: 150px;">
                                        ${state.products.map(product => `
                                            <option value="${product.id}">${product.name} - ${formatPrice(product.price)}</option>
                                        `).join('')}
                                    </select>
                                    <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-top: 0.25rem;">
                                        Maintenez Ctrl pour sélectionner plusieurs produits
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2" style="margin-top: 2rem;">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus"></i> Créer la promotion
                                    </button>
                                    <button type="button" class="btn" onclick="this.closest('[style]').remove()" style="background: #e9ecef;">
                                        Annuler
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Remplir les dates par défaut
            const today = new Date().toISOString().split('T')[0];
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            const nextMonthStr = nextMonth.toISOString().split('T')[0];
            
            document.getElementById('promotionStartDate').value = today;
            document.getElementById('promotionEndDate').value = nextMonthStr;
            
            // Gérer le formulaire
            document.getElementById('addPromotionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const promotion = {
                    id: Date.now(),
                    name: document.getElementById('promotionName').value,
                    discount: parseInt(document.getElementById('promotionDiscount').value),
                    startDate: document.getElementById('promotionStartDate').value,
                    endDate: document.getElementById('promotionEndDate').value,
                    products: Array.from(document.getElementById('promotionProducts').selectedOptions).map(opt => parseInt(opt.value))
                };
                
                state.promotions.push(promotion);
                savePromotions();
                updateCounters();
                
                document.querySelector('[style*="position: fixed"]').remove();
                showToast('Succès', 'Promotion créée avec succès!', 'success');
                showPage('promotions');
            });
        }
        
        function filterOrders(status) {
            // Implémentation simple du filtrage
            showToast('Info', `Filtrage des commandes: ${status === 'all' ? 'Toutes' : getStatusText(status)}`, 'success');
            // Dans une implémentation réelle, on filtrerait et réafficherait les commandes
        }
        
        function exportProducts() {
            const dataStr = JSON.stringify(state.products, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `targui-products-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Succès', 'Produits exportés avec succès', 'success');
        }
        
        function exportCustomers() {
            const dataStr = JSON.stringify(state.customers, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `targui-customers-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Succès', 'Clients exportés avec succès', 'success');
        }
        
        // ===== FONCTIONS BOUTIQUE =====
        function addToCart(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) {
                showToast('Erreur', 'Produit introuvable', 'error');
                return;
            }
            
            if (product.stock === 0) {
                showToast('Erreur', 'Produit en rupture de stock', 'error');
                return;
            }
            
            const existingItem = state.cart.find(item => item.productId === productId);
            if (existingItem) {
                if (existingItem.quantity >= product.stock) {
                    showToast('Erreur', 'Stock insuffisant', 'error');
                    return;
                }
                existingItem.quantity++;
            } else {
                state.cart.push({
                    productId: productId,
                    product: product,
                    quantity: 1
                });
            }
            
            saveCart();
            updateCartBadge();
            showToast('Succès', 'Produit ajouté au panier', 'success');
        }
        
        function toggleFavorite(productId) {
            const index = state.favorites.indexOf(productId);
            if (index > -1) {
                state.favorites.splice(index, 1);
                showToast('Info', 'Retiré des favoris', 'success');
            } else {
                state.favorites.push(productId);
                showToast('Succès', 'Ajouté aux favoris', 'success');
            }
            saveFavorites();
            if (state.currentPage === 'dashboard' || state.currentPage === 'categories') {
                showPage(state.currentPage);
            }
        }
        
        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        function showLogoAnimation() {
            const storeName = state.settings.storeName || 'TARGUI STORE';
            const logoUrl = state.settings.storeLogo || 'https://i.postimg.cc/C5z8J6K1/image-2-logo.jpg';
            
            // Créer la modal avec animation
            const modalHTML = `
                <div class="logo-animation-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); display: flex; justify-content: center; align-items: center; z-index: 3000; animation: fadeIn 0.3s ease;" onclick="if(event.target === this) closeLogoAnimation();">
                    <div style="position: relative; text-align: center; width: 100%; max-width: 600px; padding: 2rem;">
                        <!-- Particules flottantes -->
                        <div id="particlesContainer" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;"></div>
                        
                        <!-- Logo qui tourne -->
                        <div id="animatedLogo" style="width: 150px; height: 150px; margin: 0 auto 2rem; position: relative;">
                            <div style="width: 100%; height: 100%; border-radius: 50%; overflow: hidden; border: 4px solid rgba(255, 215, 0, 0.3); box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); animation: logoSpin 2s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
                                <img src="${logoUrl}" alt="${storeName}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <!-- Effet de glow autour du logo -->
                            <div style="position: absolute; top: -10px; left: -10px; right: -10px; bottom: -10px; border-radius: 50%; background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 70%); animation: glowPulse 2s ease-in-out infinite; pointer-events: none;"></div>
                        </div>
                        
                        <!-- Couronne animée -->
                        <div id="crownContainer" style="opacity: 0; animation: fadeInUp 0.8s ease 2.2s forwards, crownFloat 2s ease-in-out 3s infinite;">
                            <i class="fas fa-crown" style="font-size: 4rem; color: #FFD700; text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5); filter: drop-shadow(0 5px 15px rgba(255, 215, 0, 0.6));"></i>
                        </div>
                        
                        <!-- Message animé -->
                        <div id="messageContainer" style="opacity: 0; margin-top: 2rem; animation: textReveal 1s ease 2.5s forwards;">
                            <h2 style="font-size: 2.5rem; font-weight: 800; background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 0 30px rgba(255, 215, 0, 0.5); margin-bottom: 1rem; letter-spacing: 2px; line-height: 1.3;">
                                MERCI POUR VOTRE VISITE
                            </h2>
                            <p style="font-size: 1.5rem; color: #FFD700; font-weight: 600; text-shadow: 0 0 20px rgba(255, 215, 0, 0.6); letter-spacing: 1px; margin-top: 1rem;">
                                ICI LE CLIENT EST ROI
                            </p>
                        </div>
                        
                        <!-- Bouton de fermeture -->
                        <button onclick="closeLogoAnimation()" style="position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; transition: all 0.3s ease; opacity: 0; animation: fadeIn 0.5s ease 3s forwards;" onmouseenter="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='scale(1.1)'" onmouseleave="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.transform='scale(1)'">
                            ×
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Créer des particules animées
            createParticles();
            
            // Fermer automatiquement après 5 secondes
            setTimeout(() => {
                closeLogoAnimation();
            }, 5000);
        }
        
        function createParticles() {
            const container = document.getElementById('particlesContainer');
            if (!container) return;
            
            const particleCount = 30;
            const colors = ['#FFD700', '#FFA500', '#FF6347', '#FF1493', '#00CED1'];
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                const size = Math.random() * 8 + 4;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const startX = Math.random() * 100;
                const delay = Math.random() * 2;
                const duration = Math.random() * 2 + 2;
                const tx = (Math.random() - 0.5) * 200;
                
                particle.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    background: ${color};
                    border-radius: 50%;
                    left: ${startX}%;
                    top: 100%;
                    box-shadow: 0 0 ${size * 2}px ${color};
                    animation: particleFloat ${duration}s ease-out ${delay}s forwards;
                    --tx: ${tx}px;
                `;
                
                container.appendChild(particle);
            }
            
            // Ajouter des étoiles scintillantes
            for (let i = 0; i < 20; i++) {
                const star = document.createElement('div');
                const size = Math.random() * 6 + 3;
                const left = Math.random() * 100;
                const top = Math.random() * 100;
                const delay = Math.random() * 3;
                
                star.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    background: #FFD700;
                    clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
                    left: ${left}%;
                    top: ${top}%;
                    opacity: 0;
                    animation: sparkle 2s ease-in-out ${delay}s infinite;
                `;
                
                container.appendChild(star);
            }
        }
        
        function closeLogoAnimation() {
            const overlay = document.querySelector('.logo-animation-overlay');
            if (overlay) {
                overlay.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => {
                    overlay.remove();
                }, 300);
            }
        }
        
        function showCartModal() {
            const total = state.cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            const modalHTML = `
                <div class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;" onclick="if(event.target === this) closeModal();">
                    <div style="background: white; border-radius: var(--border-radius); width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation();">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--primary-blue); margin: 0;">
                                <i class="fas fa-shopping-cart"></i> Panier (${state.cart.length})
                            </h3>
                            <button type="button" onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; color: var(--secondary-gray); cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                        
                        <div style="padding: 1.5rem;">
                            ${state.cart.length > 0 ? `
                                <div style="margin-bottom: 1.5rem;">
                                    ${state.cart.map(item => `
                                        <div style="display: flex; gap: 1rem; padding: 1rem; border: 1px solid #e9ecef; border-radius: var(--border-radius-sm); margin-bottom: 1rem; align-items: center;">
                                            <img src="${item.product.images[0]}" style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--border-radius-sm);">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 700; margin-bottom: 0.25rem;">${item.product.name}</div>
                                                <div style="font-size: 0.9rem; color: var(--secondary-gray);">${item.product.brand}</div>
                                                <div style="font-weight: 800; color: var(--primary-blue); margin-top: 0.5rem;">${formatPrice(item.product.price)}</div>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <button onclick="updateCartQuantity(${item.productId}, ${item.quantity - 1})" style="background: #e9ecef; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;">-</button>
                                                <span style="min-width: 30px; text-align: center; font-weight: 700;">${item.quantity}</span>
                                                <button onclick="updateCartQuantity(${item.productId}, ${item.quantity + 1})" style="background: var(--primary-blue); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;">+</button>
                                            </div>
                                            <button onclick="removeFromCart(${item.productId})" style="background: var(--danger-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--border-radius-sm); cursor: pointer;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="border-top: 2px solid #e9ecef; padding-top: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <span style="font-size: 1.2rem; font-weight: 700;">Total:</span>
                                        <span style="font-size: 1.5rem; font-weight: 800; color: var(--primary-blue);">${formatPrice(total)}</span>
                                    </div>
                                    <button class="btn btn-primary" onclick="checkout()" style="width: 100%;">
                                        <i class="fas fa-check"></i> Passer la commande
                                    </button>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 3rem;">
                                    <i class="fas fa-shopping-cart" style="font-size: 4rem; color: var(--secondary-gray); opacity: 0.5; margin-bottom: 1rem;"></i>
                                    <h3 style="color: var(--primary-black); margin-bottom: 0.5rem;">Votre panier est vide</h3>
                                    <p style="color: var(--secondary-gray);">Ajoutez des produits pour commencer</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function updateCartQuantity(productId, newQuantity) {
            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }
            
            const item = state.cart.find(item => item.productId === productId);
            if (item) {
                const product = state.products.find(p => p.id === productId);
                if (newQuantity > product.stock) {
                    showToast('Erreur', 'Stock insuffisant', 'error');
                    return;
                }
                item.quantity = newQuantity;
                saveCart();
                updateCartBadge();
                showCartModal();
            }
        }
        
        function removeFromCart(productId) {
            state.cart = state.cart.filter(item => item.productId !== productId);
            saveCart();
            updateCartBadge();
            showCartModal();
        }
        
        function checkout() {
            if (state.cart.length === 0) {
                showToast('Erreur', 'Votre panier est vide', 'error');
                return;
            }
            
            // Vérifier si le numéro WhatsApp est configuré
            const whatsappNumber = state.settings.whatsappNumber;
            if (!whatsappNumber || whatsappNumber.trim() === '' || whatsappNumber === '+227XXXXXXXXX') {
                showToast('Info', 'Veuillez configurer le numéro WhatsApp dans les paramètres', 'success');
                showPage('settings');
                return;
            }
            
            const total = state.cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            const orderId = Date.now();
            
            // Créer le message WhatsApp avec les détails de la commande
            const itemsList = state.cart.map((item, index) => {
                return `${index + 1}. *${item.product.name}*\n   - Marque: ${item.product.brand}\n   - Catégorie: ${item.product.category}\n   - Prix unitaire: ${formatPrice(item.product.price)}\n   - Quantité: ${item.quantity}\n   - Sous-total: ${formatPrice(item.product.price * item.quantity)}`;
            }).join('\n\n');
            
            const storeName = state.settings.storeName || 'TARGUI STORE';
            const message = encodeURIComponent(
                `🛍️ *NOUVELLE COMMANDE - ${storeName}*\n\n` +
                `📦 *Commande #${orderId}*\n` +
                `📅 Date: ${new Date().toLocaleString('fr-FR')}\n\n` +
                `🛒 *PRODUITS COMMANDÉS:*\n\n${itemsList}\n\n` +
                `💰 *TOTAL: ${formatPrice(total)}*\n\n` +
                `✅ Je confirme ma commande et souhaite procéder à la livraison.\n\n` +
                `Merci de me contacter pour finaliser la commande.`
            );
            
            // Créer l'ordre
            const order = {
                id: orderId,
                items: state.cart.map(item => ({
                    ...item.product,
                    quantity: item.quantity
                })),
                total: total,
                status: 'pending',
                date: new Date().toISOString(),
                customer: { name: 'Client', phone: whatsappNumber }
            };
            
            // Sauvegarder la commande
            state.orders.push(order);
            const cartBackup = [...state.cart]; // Sauvegarder le panier avant de le vider
            state.cart = [];
            saveOrders();
            saveCart();
            updateCartBadge();
            updateCounters();
            
            // Fermer les modals
            closeModal();
            
            // Rediriger vers WhatsApp
            const whatsappUrl = `https://wa.me/${whatsappNumber.replace(/[^0-9]/g, '')}?text=${message}`;
            window.open(whatsappUrl, '_blank');
            
            showToast('Succès', 'Redirection vers WhatsApp...', 'success');
            
            // Rediriger vers la page des commandes après un court délai
            setTimeout(() => {
                showPage('customers');
            }, 1000);
        }
        
        function viewProduct(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            const allMedia = [
                ...(product.images || []).map(img => ({ type: 'image', src: img })),
                
            ];
            
            const modalHTML = `
                <div class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;" onclick="if(event.target === this) closeModal();">
                    <div style="background: white; border-radius: var(--border-radius); width: 90%; max-width: 1100px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation();">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--primary-blue); margin: 0;">${product.name}</h3>
                            <button type="button" onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; color: var(--secondary-gray); cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                                <div>
                                    <!-- Galerie d'images et vidéo -->
                                    <div style="position: relative; margin-bottom: 1rem;">
                                        <div id="productMediaContainer" style="position: relative; width: 100%; height: 400px; border-radius: var(--border-radius); overflow: hidden; background: #f8f9fa;">
                                            ${allMedia.length > 0 ? `
                                                ${allMedia.map((media, index) => `
                                                    <div class="product-media-item" data-index="${index}" style="display: ${index === 0 ? 'block' : 'none'}; width: 100%; height: 100%; position: ${index === 0 ? 'relative' : 'absolute'}; top: 0; left: 0;">
                                                        ${media.type === 'image' ? `
                                                            <img src="${media.src}" style="width: 100%; height: 100%; object-fit: contain; background: white;">
                                                        ` : `
                                                
                                                        `}
                                                    </div>
                                                `).join('')}
                                            ` : `
                                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--secondary-gray);">
                                                    <i class="fas fa-image" style="font-size: 4rem;"></i>
                                                </div>
                                            `}
                                        </div>
                                        
                                        ${allMedia.length > 1 ? `
                                            <button id="prevMediaBtn" onclick="navigateProductMedia(${productId}, -1)" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.3s ease; z-index: 10;" onmouseenter="this.style.background='white'; this.style.transform='translateY(-50%) scale(1.1)'" onmouseleave="this.style.background='rgba(255,255,255,0.9)'; this.style.transform='translateY(-50%) scale(1)'">
                                                <i class="fas fa-chevron-left" style="color: var(--primary-blue);"></i>
                                            </button>
                                            <button id="nextMediaBtn" onclick="navigateProductMedia(${productId}, 1)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.3s ease; z-index: 10;" onmouseenter="this.style.background='white'; this.style.transform='translateY(-50%) scale(1.1)'" onmouseleave="this.style.background='rgba(255,255,255,0.9)'; this.style.transform='translateY(-50%) scale(1)'">
                                                <i class="fas fa-chevron-right" style="color: var(--primary-blue);"></i>
                                            </button>
                                            
                                            <div style="position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 0.5rem; z-index: 10;">
                                                ${allMedia.map((media, index) => `
                                                    <div id="mediaIndicator${productId}_${index}" onclick="goToProductMedia(${productId}, ${index})" style="width: 10px; height: 10px; border-radius: 50%; background: ${index === 0 ? 'white' : 'rgba(255,255,255,0.5)'}; cursor: pointer; transition: all 0.3s ease; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" onmouseenter="this.style.transform='scale(1.3)'" onmouseleave="this.style.transform='scale(1)'"></div>
                                                `).join('')}
                                            </div>
                                            
                                            <div style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; z-index: 10;">
                                                <span id="mediaCounter${productId}">1 / ${allMedia.length}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <!-- Miniatures des images -->
                                    ${allMedia.length > 1 ? `
                                        <div style="display: flex; gap: 0.5rem; overflow-x: auto; padding: 0.5rem 0; scrollbar-width: thin;">
                                            ${allMedia.map((media, index) => `
                                                <div onclick="goToProductMedia(${productId}, ${index})" style="min-width: 80px; height: 80px; border-radius: var(--border-radius-sm); overflow: hidden; cursor: pointer; border: 2px solid ${index === 0 ? 'var(--primary-blue)' : 'transparent'}; transition: all 0.3s ease; opacity: ${index === 0 ? '1' : '0.7'};" onmouseenter="this.style.opacity='1'; this.style.transform='scale(1.05)'" onmouseleave="this.style.opacity='${index === 0 ? '1' : '0.7'}'; this.style.transform='scale(1)'">
                                                    ${media.type === 'image' ? `
                                                        <img src="${media.src}" style="width: 100%; height: 100%; object-fit: cover;">
                                                    ` : `
                                                        <div style="width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary-blue), var(--accent-color)); display: flex; align-items: center; justify-content: center; color: white;">
                                                            <i class="fas fa-play" style="font-size: 1.5rem;"></i>
                                                        </div>
                                                    `}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; color: var(--secondary-gray); margin-bottom: 0.5rem;">${product.category} • ${product.brand}</div>
                                    <h2 style="color: var(--primary-black); margin-bottom: 1rem;">${product.name}</h2>
                                    <div style="font-size: 2rem; font-weight: 800; color: var(--primary-blue); margin-bottom: 1.5rem;">${formatPrice(product.price)}</div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <div style="font-weight: 700; margin-bottom: 0.5rem;">Description:</div>
                                        <div style="color: var(--secondary-gray); line-height: 1.6;">${product.description || 'Aucune description disponible'}</div>
                                    </div>
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                        <button class="btn btn-primary" onclick="addToCart(${product.id}); closeModal();" style="flex: 1; min-width: 150px; position: relative; overflow: hidden; transition: all 0.3s ease;" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-lg)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'">
                                            <i class="fas fa-cart-plus"></i> Ajouter au panier
                                        </button>
                                        <button class="btn btn-success" onclick="orderViaWhatsApp(${product.id}); closeModal();" style="flex: 1; min-width: 150px; background: #25D366; color: white; border: none; transition: all 0.3s ease;" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(37, 211, 102, 0.4)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <i class="fab fa-whatsapp"></i> Commander
                                        </button>
                                        <button class="btn" onclick="toggleFavorite(${product.id})" style="background: ${state.favorites.includes(product.id) ? '#ff4757' : '#e9ecef'}; color: ${state.favorites.includes(product.id) ? 'white' : 'var(--primary-black)'}; min-width: 50px; transition: all 0.3s ease;" onmouseenter="this.style.transform='scale(1.1)'" onmouseleave="this.style.transform='scale(1)'">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                    </div>
                                    ${state.settings.storeLocation && state.settings.storeLocation.trim() ? `
                                        <button class="btn" onclick="showStoreLocation()" style="width: 100%; margin-top: 1rem; background: #e9ecef; transition: all 0.3s ease;" onmouseenter="this.style.background='#dee2e6'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseleave="this.style.background='#e9ecef'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <i class="fas fa-map-marker-alt"></i> Visiter notre emplacement
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Stocker l'index actuel pour ce produit
            if (!window.productMediaIndex) window.productMediaIndex = {};
            window.productMediaIndex[productId] = 0;
        }
        
        function navigateProductMedia(productId, direction) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            const allMedia = [
                ...(product.images || []).map(img => ({ type: 'image', src: img })),
                
            ];
            
            if (!window.productMediaIndex) window.productMediaIndex = {};
            let currentIndex = window.productMediaIndex[productId] || 0;
            
            currentIndex += direction;
            if (currentIndex < 0) currentIndex = allMedia.length - 1;
            if (currentIndex >= allMedia.length) currentIndex = 0;
            
            window.productMediaIndex[productId] = currentIndex;
            goToProductMedia(productId, currentIndex);
        }
        
        function goToProductMedia(productId, index) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            const allMedia = [
                ...(product.images || []).map(img => ({ type: 'image', src: img })),
               
            ];
            
            if (index < 0 || index >= allMedia.length) return;
            
            // Masquer tous les médias
            const mediaItems = document.querySelectorAll(`.product-media-item[data-index]`);
            mediaItems.forEach(item => {
                item.style.display = 'none';
                item.style.position = 'absolute';
            });
            
            // Afficher le média sélectionné
            const selectedItem = document.querySelector(`.product-media-item[data-index="${index}"]`);
            if (selectedItem) {
                selectedItem.style.display = 'block';
                selectedItem.style.position = 'relative';
            }
            
            // Mettre à jour les indicateurs
            allMedia.forEach((media, i) => {
                const indicator = document.getElementById(`mediaIndicator${productId}_${i}`);
                const thumbnail = document.querySelector(`[onclick="goToProductMedia(${productId}, ${i})"]`);
                
                if (indicator) {
                    indicator.style.background = i === index ? 'white' : 'rgba(255,255,255,0.5)';
                }
                
                if (thumbnail) {
                    thumbnail.style.borderColor = i === index ? 'var(--primary-blue)' : 'transparent';
                    thumbnail.style.opacity = i === index ? '1' : '0.7';
                }
            });
            
            // Mettre à jour le compteur
            const counter = document.getElementById(`mediaCounter${productId}`);
            if (counter) {
                counter.textContent = `${index + 1} / ${allMedia.length}`;
            }
            
            // Mettre à jour l'index global
            if (!window.productMediaIndex) window.productMediaIndex = {};
            window.productMediaIndex[productId] = index;
        }
        
        function filterByCategory(category) {
            state.searchQuery = category;
            state.currentFilter = 'category';
            showPage('categories');
        }
        
        function filterByBrand(brand) {
            state.searchQuery = brand;
            state.currentFilter = 'brand';
            showPage('categories');
        }
        
        function filterByFavorites() {
            state.searchQuery = '';
            state.currentFilter = 'favorites';
            showPage('categories');
        }
        
        function orderViaWhatsApp(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            const whatsappNumber = state.settings.whatsappNumber || '+227XXXXXXXXX';
            const message = encodeURIComponent(
                `🛍️ *Commande - ${product.name}*\n\n` +
                `💰 Prix: ${formatPrice(product.price)}\n` +
                `📱 Marque: ${product.brand}\n` +
                `📦 Catégorie: ${product.category}\n` +
                `${product.description ? `\n📝 Description: ${product.description}\n` : ''}` +
                `\n✅ Je souhaite commander ce produit.\n\n` +
                `Merci de me contacter pour finaliser la commande.`
            );
            
            const whatsappUrl = `https://wa.me/${whatsappNumber.replace(/[^0-9]/g, '')}?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }
        
        function showStoreLocation() {
            const location = state.settings.storeLocation;
            if (location && location.trim()) {
                // Ouvrir le lien Maps dans un nouvel onglet
                window.open(location.trim(), '_blank');
            } else {
                showToast('Info', 'Aucun emplacement configuré dans les paramètres', 'success');
            }
        }
        
        function updateLogoPreview(url) {
            const preview = document.getElementById('logoPreview');
            if (preview && url) {
                preview.innerHTML = `<img src="${url}" style="max-width: 200px; max-height: 100px; border-radius: var(--border-radius-sm); border: 2px solid #e9ecef; padding: 0.5rem; background: white; object-fit: contain;">`;
            } else if (preview) {
                preview.innerHTML = '<i class="fas fa-image" style="font-size: 2rem;"></i>';
            }
        }
        
        function getCategoryIcon(category) {
            const icons = {
                'Électronique': '📱',
                'Mode': '👕',
                'Maison': '🏠',
                'Beauté': '💄',
                'Sport': '⚽',
                'Informatique': '💻',
                'Photographie': '📷'
            };
            return icons[category] || '📦';
        }
        
        async function showAddBrandModal() {
            showCustomPrompt('Nouvelle marque', 'Entrez le nom de la nouvelle marque', async (brandName) => {
                const trimmedBrand = brandName.trim();
                if (!trimmedBrand) {
                    showToast('Erreur', 'Le nom de la marque ne peut pas être vide', 'error');
                    return;
                }
                
                if (!state.customBrands.includes(trimmedBrand)) {
                    state.customBrands.push(trimmedBrand);
                    await saveCustomBrands();
                    showToast('Succès', 'Marque ajoutée avec succès!', 'success');
                    
                    // Mettre à jour tous les selects de marque
                    const selects = document.querySelectorAll('#productBrand, #scanProductBrand');
                    selects.forEach(select => {
                    if (select) {
                        const option = document.createElement('option');
                        option.value = trimmedBrand;
                        option.textContent = trimmedBrand;
                        select.appendChild(option);
                        select.value = trimmedBrand;
                        }
                    });
                    
                    // Si on est sur la page d'ajout de produit, recharger le contenu
                    if (state.currentPage === 'add-product') {
                        showPage('add-product');
                    }
                } else {
                    showToast('Info', 'Cette marque existe déjà', 'info');
                }
            });
        }
        
        async function showAddCategoryModal() {
            showCustomPrompt('Nouvelle catégorie', 'Entrez le nom de la nouvelle catégorie', async (categoryName) => {
                const trimmedCategory = categoryName.trim();
                if (!trimmedCategory) {
                    showToast('Erreur', 'Le nom de la catégorie ne peut pas être vide', 'error');
                    return;
                }
                
                if (!state.customCategories.includes(trimmedCategory)) {
                    state.customCategories.push(trimmedCategory);
                    await saveCustomCategories();
                    showToast('Succès', 'Catégorie ajoutée avec succès!', 'success');
                    
                    // Mettre à jour tous les selects de catégorie
                    const selects = document.querySelectorAll('#productCategory, #scanProductCategory');
                    selects.forEach(select => {
                    if (select) {
                        const option = document.createElement('option');
                        option.value = trimmedCategory;
                        option.textContent = trimmedCategory;
                        select.appendChild(option);
                        select.value = trimmedCategory;
                        }
                    });
                    
                    // Si on est sur la page d'ajout de produit, recharger le contenu
                    if (state.currentPage === 'add-product') {
                        showPage('add-product');
                    }
                } else {
                    showToast('Info', 'Cette catégorie existe déjà', 'info');
                }
            });
        }
        
        function updateCartBadge() {
            const badge = document.getElementById('cartBadge');
            if (badge) {
                badge.textContent = state.cart.length;
                badge.style.display = state.cart.length > 0 ? 'flex' : 'none';
            }
        }
        
        // ===== SAUVEGARDE SUPABASE =====
        async function saveProducts() {
            if (USE_SUPABASE && supabase) {
                try {
                    // Sauvegarder chaque produit dans Supabase
                    for (const product of state.products) {
                        // Préparer les données du produit
                        const productData = {
                            id: product.id,
                            name: product.name,
                            brand: product.brand || null,
                            category: product.category || null,
                            description: product.description || null,
                            price: product.price,
                            stock: product.stock || 0,
                            tags: product.tags || [],
                            promotion_id: product.promotionId || null,
                            created_at: product.createdAt || new Date().toISOString(),
                            updated_at: product.updatedAt || new Date().toISOString()
                        };
                        
                        // Vérifier si le produit existe déjà
                        const { data: existing, error: checkError } = await supabase
                            .from('products')
                            .select('id')
                            .eq('id', product.id)
                            .maybeSingle();
                        
                        if (checkError && checkError.code !== 'PGRST116') {
                            console.error('Erreur vérification produit:', checkError);
                        }
                        
                        if (existing) {
                            // Mettre à jour
                            await supabase
                                .from('products')
                                .update(productData)
                                .eq('id', product.id);
                        } else {
                            // Insérer
                            await supabase
                                .from('products')
                                .insert(productData);
                        }
                        
                        // Sauvegarder les images
                        if (product.images && product.images.length > 0) {
                            // Supprimer les anciennes images
                            await supabase
                                .from('product_images')
                                .delete()
                                .eq('product_id', product.id);
                            
                            // Insérer les nouvelles images
                            const imageInserts = product.images.map((imageBase64, index) => ({
                                product_id: product.id,
                                image_base64: imageBase64,
                                image_order: index
                            }));
                            
                            if (imageInserts.length > 0) {
                                await supabase
                                    .from('product_images')
                                    .insert(imageInserts);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erreur sauvegarde produits Supabase:', error);
                    // Fallback sur localStorage
            localStorage.setItem('targui_products', JSON.stringify(state.products));
                }
            } else {
                localStorage.setItem('targui_products', JSON.stringify(state.products));
            }
        }
        
        async function saveOrders() {
            if (USE_SUPABASE && supabase) {
                try {
                    for (const order of state.orders) {
                        const orderData = {
                            id: order.id,
                            customer_id: order.customer?.id || null,
                            total: order.total,
                            status: order.status || 'pending',
                            order_date: order.date || new Date().toISOString(),
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        
                        const { data: existing, error: checkError } = await supabase
                            .from('orders')
                            .select('id')
                            .eq('id', order.id)
                            .maybeSingle();
                        
                        if (checkError && checkError.code !== 'PGRST116') {
                            console.error('Erreur vérification commande:', checkError);
                        }
                        
                        if (existing) {
                            await supabase.from('orders').update(orderData).eq('id', order.id);
                        } else {
                            await supabase.from('orders').insert(orderData);
                        }
                        
                        // Sauvegarder les articles de commande
                        if (order.items && order.items.length > 0) {
                            await supabase
                                .from('order_items')
                                .delete()
                                .eq('order_id', order.id);
                            
                            const items = order.items.map(item => ({
                                order_id: order.id,
                                product_id: item.id,
                                quantity: 1,
                                unit_price: item.price,
                                total_price: item.price
                            }));
                            
                            if (items.length > 0) {
                                await supabase.from('order_items').insert(items);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erreur sauvegarde commandes Supabase:', error);
            localStorage.setItem('targui_orders', JSON.stringify(state.orders));
                }
            } else {
                localStorage.setItem('targui_orders', JSON.stringify(state.orders));
            }
        }
        
        async function saveCustomers() {
            if (USE_SUPABASE && supabase) {
                try {
                    for (const customer of state.customers) {
                        const customerData = {
                            id: customer.id,
                            name: customer.name,
                            email: customer.email || null,
                            phone: customer.phone || null,
                            total_orders: customer.orders || 0,
                            total_spent: customer.totalSpent || 0,
                            joined_at: customer.joined || new Date().toISOString(),
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        
                        const { data: existing, error: checkError } = await supabase
                            .from('customers')
                            .select('id')
                            .eq('id', customer.id)
                            .maybeSingle();
                        
                        if (checkError && checkError.code !== 'PGRST116') {
                            console.error('Erreur vérification client:', checkError);
                        }
                        
                        if (existing) {
                            await supabase.from('customers').update(customerData).eq('id', customer.id);
                        } else {
                            await supabase.from('customers').insert(customerData);
                        }
                    }
                } catch (error) {
                    console.error('Erreur sauvegarde clients Supabase:', error);
            localStorage.setItem('targui_customers', JSON.stringify(state.customers));
                }
            } else {
                localStorage.setItem('targui_customers', JSON.stringify(state.customers));
            }
        }
        
        async function savePromotions() {
            if (USE_SUPABASE && supabase) {
                try {
                    for (const promo of state.promotions) {
                        const promoData = {
                            id: promo.id,
                            name: promo.name,
                            discount_percentage: promo.discount,
                            start_date: promo.startDate,
                            end_date: promo.endDate,
                            is_active: true,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        
                        const { data: existing, error: checkError } = await supabase
                            .from('promotions')
                            .select('id')
                            .eq('id', promo.id)
                            .maybeSingle();
                        
                        if (checkError && checkError.code !== 'PGRST116') {
                            console.error('Erreur vérification promotion:', checkError);
                        }
                        
                        if (existing) {
                            await supabase.from('promotions').update(promoData).eq('id', promo.id);
                        } else {
                            await supabase.from('promotions').insert(promoData);
                        }
                    }
                } catch (error) {
                    console.error('Erreur sauvegarde promotions Supabase:', error);
            localStorage.setItem('targui_promotions', JSON.stringify(state.promotions));
                }
            } else {
                localStorage.setItem('targui_promotions', JSON.stringify(state.promotions));
            }
        }
        
        async function saveSettings() {
            if (USE_SUPABASE && supabase) {
                try {
                    const settingsData = {
                        whatsapp_number: state.settings.whatsappNumber || null,
                        currency: state.settings.currency || 'FCFA',
                        store_name: state.settings.storeName || null,
                        contact_email: state.settings.contactEmail || null,
                        store_address: state.settings.storeAddress || null,
                        store_location: state.settings.storeLocation || null,
                        store_logo_base64: state.settings.storeLogo || null,
                        facebook_url: state.settings.facebookUrl || null,
                        instagram_url: state.settings.instagramUrl || null,
                        tiktok_url: state.settings.tiktokUrl || null,
                        linkedin_url: state.settings.linkedinUrl || null,
                        twitter_url: state.settings.twitterUrl || null,
                        updated_at: new Date().toISOString()
                    };
                    
                    const { data: existing, error: checkError } = await supabase
                        .from('settings')
                        .select('id')
                        .limit(1)
                        .maybeSingle();
                    
                    if (checkError && checkError.code !== 'PGRST116') {
                        console.error('Erreur vérification paramètres:', checkError);
                    }
                    
                    if (existing) {
                        await supabase.from('settings').update(settingsData).eq('id', existing.id);
                    } else {
                        await supabase.from('settings').insert(settingsData);
                    }
                } catch (error) {
                    console.error('Erreur sauvegarde paramètres Supabase:', error);
            localStorage.setItem('targui_settings', JSON.stringify(state.settings));
                }
            } else {
                localStorage.setItem('targui_settings', JSON.stringify(state.settings));
            }
        }
        
        async function saveCustomCategories() {
            if (USE_SUPABASE && supabase) {
                try {
                    for (const category of state.customCategories) {
                        await supabase
                            .from('custom_categories')
                            .upsert({ name: category }, { onConflict: 'name' });
                    }
                } catch (error) {
                    console.error('Erreur sauvegarde catégories Supabase:', error);
            localStorage.setItem('targui_custom_categories', JSON.stringify(state.customCategories));
                }
            } else {
                localStorage.setItem('targui_custom_categories', JSON.stringify(state.customCategories));
            }
        }
        
        async function saveCustomBrands() {
            if (USE_SUPABASE && supabase) {
                try {
                    for (const brand of state.customBrands) {
                        await supabase
                            .from('custom_brands')
                            .upsert({ name: brand }, { onConflict: 'name' });
                    }
                } catch (error) {
                    console.error('Erreur sauvegarde marques Supabase:', error);
            localStorage.setItem('targui_custom_brands', JSON.stringify(state.customBrands));
                }
            } else {
                localStorage.setItem('targui_custom_brands', JSON.stringify(state.customBrands));
            }
        }
        
        function saveCart() {
            // Le panier reste en localStorage (temporaire)
            localStorage.setItem('targui_cart', JSON.stringify(state.cart));
        }
        
        function saveFavorites() {
            // Les favoris restent en localStorage (temporaire)
            localStorage.setItem('targui_favorites', JSON.stringify(state.favorites));
        }
        
        // ===== CHARGEMENT DEPUIS SUPABASE =====
        async function loadFromSupabase() {
            if (!USE_SUPABASE || !supabase) {
                console.log('Supabase non activé, utilisation de localStorage');
                return;
            }
            
            try {
                // Charger les produits
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (!productsError && products) {
                    // Charger les images pour chaque produit
                    for (const product of products) {
                        const { data: images } = await supabase
                            .from('product_images')
                            .select('image_base64')
                            .eq('product_id', product.id)
                            .order('image_order');
                        
                        product.images = images ? images.map(img => img.image_base64) : [];
                        
                        product.tags = product.tags || [];
                        product.promotionId = product.promotion_id;
                        product.createdAt = product.created_at;
                        product.updatedAt = product.updated_at;
                    }
                    
                    state.products = products || [];
                    console.log(`✅ ${products.length} produits chargés depuis Supabase`);
                }
                
                // Charger les clients
                const { data: customers } = await supabase
                    .from('customers')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (customers) {
                    state.customers = customers.map(c => ({
                        id: c.id,
                        name: c.name,
                        email: c.email,
                        phone: c.phone,
                        orders: c.total_orders,
                        totalSpent: c.total_spent,
                        joined: c.joined_at
                    }));
                    console.log(`✅ ${customers.length} clients chargés depuis Supabase`);
                }
                
                // Charger les commandes
                const { data: orders } = await supabase
                    .from('orders')
                    .select('*, order_items(*, products(*))')
                    .order('order_date', { ascending: false });
                
                if (orders) {
                    state.orders = orders.map(o => ({
                        id: o.id,
                        customer: state.customers.find(c => c.id === o.customer_id),
                        items: o.order_items?.map(oi => oi.products) || [],
                        total: o.total,
                        status: o.status,
                        date: o.order_date
                    }));
                    console.log(`✅ ${orders.length} commandes chargées depuis Supabase`);
                }
                
                // Charger les promotions
                const { data: promotions } = await supabase
                    .from('promotions')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (promotions) {
                    state.promotions = promotions.map(p => ({
                        id: p.id,
                        name: p.name,
                        discount: p.discount_percentage,
                        startDate: p.start_date,
                        endDate: p.end_date
                    }));
                    console.log(`✅ ${promotions.length} promotions chargées depuis Supabase`);
                }
                
                // Charger les paramètres
                const { data: settings } = await supabase
                    .from('settings')
                    .select('*')
                    .limit(1)
                    .single();
                
                if (settings) {
                    state.settings = {
                        whatsappNumber: settings.whatsapp_number || "",
                        currency: settings.currency || "FCFA",
                        storeName: settings.store_name || "",
                        contactEmail: settings.contact_email || "",
                        storeAddress: settings.store_address || "",
                        storeLocation: settings.store_location || "",
                        storeLogo: settings.store_logo_base64 || "",
                        facebookUrl: settings.facebook_url || "",
                        instagramUrl: settings.instagram_url || "",
                        tiktokUrl: settings.tiktok_url || "",
                        linkedinUrl: settings.linkedin_url || "",
                        twitterUrl: settings.twitter_url || ""
                    };
                    console.log('✅ Paramètres chargés depuis Supabase');
                }
                
                // Charger les catégories personnalisées
                const { data: categories } = await supabase
                    .from('custom_categories')
                    .select('name')
                    .order('name');
                
                if (categories) {
                    state.customCategories = categories.map(c => c.name);
                    console.log(`✅ ${categories.length} catégories chargées depuis Supabase`);
                }
                
                // Charger les marques personnalisées
                const { data: brands } = await supabase
                    .from('custom_brands')
                    .select('name')
                    .order('name');
                
                if (brands) {
                    state.customBrands = brands.map(b => b.name);
                    console.log(`✅ ${brands.length} marques chargées depuis Supabase`);
                }
                
            } catch (error) {
                console.error('Erreur chargement Supabase:', error);
                showToast('Avertissement', 'Erreur de connexion à la base de données. Utilisation des données locales.', 'warning');
            }
        }
        
        // ===== FONCTIONS GLOBALES =====
        window.showPage = showPage;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.shareProduct = shareProduct;
        window.deletePromotion = deletePromotion;
        window.showAddPromotionModal = showAddPromotionModal;
        window.viewOrder = viewOrder;
        window.contactCustomer = contactCustomer;
        window.filterOrders = filterOrders;
        window.exportProducts = exportProducts;
        window.exportCustomers = exportCustomers;
        window.resetSettings = resetSettings;
        window.addToCart = addToCart;
        window.toggleFavorite = toggleFavorite;
        window.showCartModal = showCartModal;
        window.updateCartQuantity = updateCartQuantity;
        window.removeFromCart = removeFromCart;
        window.checkout = checkout;
        window.viewProduct = viewProduct;
        window.filterByCategory = filterByCategory;
        window.filterByBrand = filterByBrand;
        window.showAddBrandModal = showAddBrandModal;
        window.showAddCategoryModal = showAddCategoryModal;
        window.showManageBrandsModal = showManageBrandsModal;
        window.showManageCategoriesModal = showManageCategoriesModal;
        window.deleteCustomBrand = deleteCustomBrand;
        window.deleteCustomCategory = deleteCustomCategory;
        window.closeModal = closeModal;
        window.updateImageCount = updateImageCount;
        window.updateProductPreview = updateProductPreview;
        window.togglePreviewPanel = togglePreviewPanel;
        
        // ===== FONCTIONS COMPTABILITÉ =====
        let scannerDetectionState = {
            detectedType: null,
            lastScanTime: 0,
            scanCount: 0,
            deviceInfo: null
        };
        
        async function detectBarcodeScanners() {
            const detectedScanners = [];
            
            // 1. Détection via API HID (pour scanners USB HID)
            if (navigator.hid) {
                try {
                    const devices = await navigator.hid.getDevices();
                    const scannerDevices = devices.filter(device => {
                        const productName = (device.productName || '').toLowerCase();
                        const vendorName = (device.manufacturerName || '').toLowerCase();
                        return productName.includes('scanner') || 
                               productName.includes('barcode') || 
                               productName.includes('qr') ||
                               vendorName.includes('symbol') ||
                               vendorName.includes('honeywell') ||
                               vendorName.includes('zebra') ||
                               vendorName.includes('datalogic');
                    });
                    
                    if (scannerDevices.length > 0) {
                        detectedScanners.push({
                            type: 'USB HID',
                            count: scannerDevices.length,
                            devices: scannerDevices.map(d => d.productName || 'Scanner USB')
                        });
                    }
                } catch (e) {
                    console.log('HID API not available or permission denied');
                }
            }
            
            // 2. Détection via API WebUSB
            if (navigator.usb) {
                try {
                    // Note: WebUSB nécessite une interaction utilisateur pour l'accès
                    // On peut juste vérifier si l'API est disponible
                    detectedScanners.push({
                        type: 'WebUSB',
                        available: true,
                        note: 'Cliquez sur "Demander l\'accès USB" pour détecter'
                    });
                } catch (e) {
                    console.log('WebUSB API not available');
                }
            }
            
            // 3. Détection via événements clavier (détection comportementale)
            // Cette méthode fonctionne pour tous les scanners qui émulent un clavier
            detectedScanners.push({
                type: 'Clavier USB/Bluetooth',
                available: true,
                note: 'Détection automatique lors du scan'
            });
            
            return detectedScanners;
        }
        
        async function requestUSBAccess() {
            if (!navigator.usb) {
                showToast('Info', 'Votre navigateur ne supporte pas l\'API WebUSB', 'success');
                return;
            }
            
            try {
                const device = await navigator.usb.requestDevice({
                    filters: [
                        { classCode: 3 }, // HID devices
                        { classCode: 255 } // Vendor specific
                    ]
                });
                
                showToast('Succès', `Scanner USB détecté: ${device.productName || 'Périphérique USB'}`, 'success');
                scannerDetectionState.deviceInfo = {
                    vendorId: device.vendorId,
                    productId: device.productId,
                    productName: device.productName,
                    manufacturerName: device.manufacturerName
                };
                
                updateScannerStatus('USB', device.productName || 'Scanner USB');
            } catch (e) {
                if (e.name !== 'NotFoundError') {
                    showToast('Erreur', 'Erreur lors de la détection USB', 'error');
                }
            }
        }
        
        function initBarcodeScanner() {
            const barcodeInput = document.getElementById('barcodeInput');
            const scannerStatus = document.getElementById('scannerStatus');
            
            if (!barcodeInput) return;
            
            // Détecter automatiquement les scanners disponibles
            detectBarcodeScanners().then(scanners => {
                if (scanners.length > 0) {
                    const scannerTypes = scanners.map(s => s.type).join(', ');
                    console.log('Scanners détectés:', scanners);
                }
            });
            
            // Système de détection amélioré pour tous types de scanners
            let lastKeyTime = 0;
            let barcodeBuffer = '';
            let isScannerDetected = false;
            let keyCount = 0;
            let scanStartTime = 0;
            let keyTimings = [];
            
            const detectScanner = (e) => {
                const now = Date.now();
                const timeDiff = now - lastKeyTime;
                
                if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey && !e.shiftKey) {
                    // Démarrer le chronométrage du scan
                    if (keyCount === 0) {
                        scanStartTime = now;
                        keyTimings = [];
                    }
                    
                    keyCount++;
                    keyTimings.push(timeDiff);
                    
                    // Détection basée sur la vitesse de saisie
                    // Les scanners envoient généralement les caractères en < 50ms
                    if (timeDiff > 0 && timeDiff < 50 && keyCount > 2) {
                        isScannerDetected = true;
                        scannerDetectionState.detectedType = 'USB/Bluetooth Scanner';
                    }
                    
                    // Détection basée sur la régularité (scanners ont un timing régulier)
                    if (keyTimings.length > 3) {
                        const avgTiming = keyTimings.slice(-4).reduce((a, b) => a + b, 0) / 4;
                        const variance = keyTimings.slice(-4).reduce((sum, t) => sum + Math.pow(t - avgTiming, 2), 0) / 4;
                        
                        // Si le timing est très régulier (< 20ms de variance), c'est probablement un scanner
                        if (variance < 400 && avgTiming < 100) {
                            isScannerDetected = true;
                            scannerDetectionState.detectedType = 'QR/Barcode Scanner';
                        }
                    }
                    
                    barcodeBuffer += e.key;
                    lastKeyTime = now;
                    
                    // Mettre à jour le statut en temps réel
                    if (isScannerDetected && scannerStatus) {
                        scannerStatus.innerHTML = '<i class="fas fa-circle" style="color: #28a745; font-size: 0.6rem; animation: pulse 1s infinite;"></i><span>Scanner actif</span>';
                        scannerStatus.style.background = 'rgba(40, 167, 69, 0.1)';
                    }
                    
                    // Réinitialiser après 300ms d'inactivité (augmenté pour les scanners lents)
                    clearTimeout(window.barcodeTimeout);
                    window.barcodeTimeout = setTimeout(() => {
                        if (barcodeBuffer.length > 0) {
                            const scanDuration = now - scanStartTime;
                            const avgKeyTime = scanDuration / keyCount;
                            
                            // Si le scan est très rapide (< 100ms par caractère en moyenne), c'est un scanner
                            if (isScannerDetected || (avgKeyTime < 100 && keyCount > 5)) {
                                processBarcode(barcodeBuffer.trim());
                                scannerDetectionState.scanCount++;
                                scannerDetectionState.lastScanTime = now;
                            } else if (keyCount > 8) {
                                // Code-barres long = probablement un scanner
                                processBarcode(barcodeBuffer.trim());
                            }
                            
                            barcodeBuffer = '';
                            keyCount = 0;
                            isScannerDetected = false;
                            keyTimings = [];
                            
                            // Réinitialiser le statut
                            if (scannerStatus) {
                                scannerStatus.innerHTML = '<i class="fas fa-circle" style="color: #ffc107; font-size: 0.6rem;"></i><span>En attente...</span>';
                                scannerStatus.style.background = 'rgba(255, 193, 7, 0.1)';
                            }
                        }
                    }, 300);
                }
                
                // Détection de la touche Enter (utilisée par la plupart des scanners)
                if (e.key === 'Enter' && barcodeBuffer.length > 0) {
                    e.preventDefault();
                    
                    // Si Enter arrive rapidement après les caractères, c'est un scanner
                    const enterTime = now - lastKeyTime;
                    if (enterTime < 200 || isScannerDetected || keyCount > 5) {
                        processBarcode(barcodeBuffer.trim());
                        scannerDetectionState.scanCount++;
                        scannerDetectionState.lastScanTime = now;
                    } else {
                        // Saisie manuelle
                        processBarcode(barcodeBuffer.trim());
                    }
                    
                    barcodeBuffer = '';
                    keyCount = 0;
                    isScannerDetected = false;
                    keyTimings = [];
                    
                    if (scannerStatus) {
                        scannerStatus.innerHTML = '<i class="fas fa-circle" style="color: #ffc107; font-size: 0.6rem;"></i><span>En attente...</span>';
                        scannerStatus.style.background = 'rgba(255, 193, 7, 0.1)';
                    }
                }
            };
            
            // Supprimer l'ancien listener s'il existe
            barcodeInput.removeEventListener('keydown', detectScanner);
            barcodeInput.addEventListener('keydown', detectScanner);
            
            // Écouter aussi les événements keypress pour une meilleure détection
            barcodeInput.addEventListener('keypress', (e) => {
                // Certains scanners envoient aussi des keypress
            });
            
            state.barcodeScannerActive = true;
            barcodeInput.focus();
            
            // Mettre à jour le statut initial
            updateScannerStatus('waiting', 'En attente du scanner...');
            
            showToast('Info', 'Scanner activé - Branchez votre scanner USB/Bluetooth et scannez', 'success');
        }
        
        function updateScannerStatus(type, message) {
            const scannerStatus = document.getElementById('scannerStatus');
            if (!scannerStatus) return;
            
            const statusConfig = {
                'waiting': {
                    icon: '<i class="fas fa-circle" style="color: #ffc107; font-size: 0.6rem;"></i>',
                    bg: 'rgba(255, 193, 7, 0.1)',
                    text: message || 'En attente du scanner...'
                },
                'active': {
                    icon: '<i class="fas fa-circle" style="color: #28a745; font-size: 0.6rem; animation: pulse 1s infinite;"></i>',
                    bg: 'rgba(40, 167, 69, 0.1)',
                    text: message || 'Scanner actif'
                },
                'USB': {
                    icon: '<i class="fas fa-usb" style="color: #0056D2; font-size: 0.8rem;"></i>',
                    bg: 'rgba(0, 86, 210, 0.1)',
                    text: message || 'Scanner USB détecté'
                },
                'Bluetooth': {
                    icon: '<i class="fas fa-bluetooth" style="color: #0056D2; font-size: 0.8rem;"></i>',
                    bg: 'rgba(0, 86, 210, 0.1)',
                    text: message || 'Scanner Bluetooth détecté'
                }
            };
            
            const config = statusConfig[type] || statusConfig['waiting'];
            scannerStatus.innerHTML = `${config.icon}<span>${config.text}</span>`;
            scannerStatus.style.background = config.bg;
        }
        
        function processBarcode(barcode) {
            // Chercher le produit par code-barres ou ID
            const product = state.products.find(p => 
                (p.barcode && p.barcode === barcode) || 
                p.id.toString() === barcode ||
                p.id.toString().padStart(8, '0') === barcode
            );
            
            if (product) {
                // Produit trouvé - afficher la modal de vente
                const barcodeInput = document.getElementById('barcodeInput');
                if (barcodeInput) barcodeInput.value = '';
                showScannedProductModal(product);
            } else {
                // Produit non trouvé - proposer de l'ajouter
                showAddProductFromScanModal(barcode);
            }
        }
        
        function showAddProductFromScanModal(barcode) {
            const modalHTML = `
                <div class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;" onclick="if(event.target === this) closeModal();">
                    <div style="background: white; border-radius: var(--border-radius); width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease;" onclick="event.stopPropagation();">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-plus-circle"></i>
                                <span>Nouveau produit détecté</span>
                            </h3>
                            <button type="button" onclick="closeModal()" style="background: rgba(255,255,255,0.2); border: none; font-size: 1.5rem; color: white; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                        <div style="padding: 2rem;">
                            <div style="background: #e7f5ff; padding: 1rem; border-radius: var(--border-radius-sm); margin-bottom: 1.5rem; border-left: 4px solid #28a745;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <i class="fas fa-info-circle" style="color: #28a745; font-size: 1.2rem;"></i>
                                    <div>
                                        <div style="font-weight: 700; color: var(--primary-black); margin-bottom: 0.25rem;">Produit non trouvé</div>
                                        <div style="font-size: 0.9rem; color: var(--secondary-gray);">
                                            Code-barres scanné: <span style="font-family: monospace; font-weight: 700; color: var(--primary-blue);">${barcode}</span>
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-top: 0.5rem;">
                                            Complétez les informations ci-dessous pour ajouter ce produit à votre catalogue.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="addProductFromScanForm">
                                <div class="form-group">
                                    <label class="form-label">Code-barres *</label>
                                    <input type="text" class="form-control" id="scanBarcode" value="${barcode}" readonly style="background: #f8f9fa; font-family: monospace; font-weight: 700;">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Nom du produit *</label>
                                    <input type="text" class="form-control" id="scanProductName" placeholder="Ex: iPhone 14 Pro Max" required>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Marque *</label>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <select class="form-select" id="scanProductBrand" required>
                                                <option value="">Choisir une marque...</option>
                                                ${state.customBrands.map(brand => `<option value="${brand}">${brand}</option>`).join('')}
                                            </select>
                                            <button type="button" class="btn btn-sm" onclick="showAddBrandModal()" style="white-space: nowrap;">
                                                <i class="fas fa-plus"></i> Nouvelle
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Catégorie *</label>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <select class="form-select" id="scanProductCategory" required>
                                                <option value="">Choisir une catégorie...</option>
                                                ${state.customCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                            </select>
                                            <button type="button" class="btn btn-sm" onclick="showAddCategoryModal()" style="white-space: nowrap;">
                                                <i class="fas fa-plus"></i> Nouvelle
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Prix *</label>
                                        <input type="number" class="form-control" id="scanProductPrice" placeholder="0" min="0" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Stock initial *</label>
                                        <input type="number" class="form-control" id="scanProductStock" value="1" min="0" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="scanProductDescription" rows="3" placeholder="Description du produit..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Image du produit (URL)</label>
                                    <input type="url" class="form-control" id="scanProductImage" placeholder="https://...">
                                    <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-top: 0.25rem;">
                                        Vous pourrez ajouter plus d'images après la création
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                    <button type="button" class="btn" onclick="closeModal()" style="flex: 1; background: #e9ecef;">
                                        Annuler
                                    </button>
                                    <button type="submit" class="btn btn-success" style="flex: 2; background: #28a745;">
                                        <i class="fas fa-save"></i> Ajouter le produit
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Gérer la soumission du formulaire
            document.getElementById('addProductFromScanForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addProductFromScan(barcode);
            });
        }
        
        function addProductFromScan(barcode) {
            const name = document.getElementById('scanProductName').value.trim();
            const brand = document.getElementById('scanProductBrand').value;
            const category = document.getElementById('scanProductCategory').value;
            const price = parseInt(document.getElementById('scanProductPrice').value);
            const stock = parseInt(document.getElementById('scanProductStock').value);
            const description = document.getElementById('scanProductDescription').value.trim();
            const imageUrl = document.getElementById('scanProductImage').value.trim();
            
            // Validation
            if (!name || !brand || !category || !price || stock < 0) {
                showToast('Erreur', 'Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            // Créer le produit
            const newProduct = {
                id: Date.now(),
                name: name,
                brand: brand,
                category: category,
                price: price,
                stock: stock,
                description: description,
                images: imageUrl ? [imageUrl] : ['https://via.placeholder.com/300x300?text=' + encodeURIComponent(name)],
                
                tags: [],
                barcode: barcode, // Sauvegarder le code-barres
                promotionId: null
            };
            
            // Ajouter le produit
            state.products.push(newProduct);
            saveProducts();
            updateCounters();
            
            closeModal();
            showToast('Succès', `Produit "${name}" ajouté avec succès!`, 'success');
            
            // Recharger la page comptabilité
            if (state.currentPage === 'accounting') {
                setTimeout(() => {
                    showPage('accounting');
                    // Proposer de vendre immédiatement
                    setTimeout(() => {
                        showScannedProductModal(newProduct);
                    }, 500);
                }, 300);
            }
        }
        
        function showAddProductByScanModal() {
            const modalHTML = `
                <div class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;" onclick="if(event.target === this) closeModal();">
                    <div style="background: white; border-radius: var(--border-radius); width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease;" onclick="event.stopPropagation();">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-barcode"></i>
                                <span>Scanner pour ajouter un produit</span>
                            </h3>
                            <button type="button" onclick="closeModal()" style="background: rgba(255,255,255,0.2); border: none; font-size: 1.5rem; color: white; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                        <div style="padding: 2rem;">
                            <div style="text-align: center; margin-bottom: 2rem;">
                                <i class="fas fa-qrcode" style="font-size: 4rem; color: #28a745; margin-bottom: 1rem;"></i>
                                <h4 style="color: var(--primary-black); margin-bottom: 0.5rem;">Scannez le code-barres</h4>
                                <p style="color: var(--secondary-gray);">Utilisez votre scanner pour lire le code-barres du produit à ajouter</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Code-barres</label>
                                <input 
                                    type="text" 
                                    id="addProductScanInput" 
                                    class="form-control" 
                                    placeholder="Scannez ou entrez le code-barres..."
                                    style="font-size: 1.2rem; padding: 1rem; font-family: monospace; text-align: center;"
                                    autofocus
                                    autocomplete="off"
                                >
                            </div>
                            
                            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                <button type="button" class="btn" onclick="closeModal()" style="flex: 1; background: #e9ecef;">
                                    Annuler
                                </button>
                                <button type="button" class="btn btn-success" onclick="processAddProductScan()" style="flex: 2; background: #28a745;">
                                    <i class="fas fa-check"></i> Continuer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Focus sur l'input et détecter le scanner
            const input = document.getElementById('addProductScanInput');
            if (input) {
                input.focus();
                
                // Détecter la touche Entrée ou un scan rapide
                let barcodeBuffer = '';
                let lastKeyTime = 0;
                
                input.addEventListener('keydown', function(e) {
                    const now = Date.now();
                    const timeDiff = now - lastKeyTime;
                    
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (input.value.trim()) {
                            processAddProductScan();
                        }
                    } else if (e.key.length === 1 && timeDiff < 50) {
                        // Scanner détecté (saisie rapide)
                        barcodeBuffer += e.key;
                        setTimeout(() => {
                            if (barcodeBuffer.length > 5) {
                                processAddProductScan();
                            }
                        }, 200);
                    }
                    
                    lastKeyTime = now;
                });
            }
        }
        
        function processAddProductScan() {
            const input = document.getElementById('addProductScanInput');
            if (!input || !input.value.trim()) {
                showToast('Erreur', 'Veuillez scanner ou entrer un code-barres', 'error');
                return;
            }
            
            const barcode = input.value.trim();
            closeModal();
            
            // Vérifier si le produit existe déjà
            const existingProduct = state.products.find(p => 
                (p.barcode && p.barcode === barcode) || 
                p.id.toString() === barcode
            );
            
            if (existingProduct) {
                showToast('Info', 'Ce produit existe déjà dans votre catalogue', 'success');
                showScannedProductModal(existingProduct);
            } else {
                showAddProductFromScanModal(barcode);
            }
        }
        
        function showScannedProductModal(product) {
            const modalHTML = `
                <div class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;" onclick="if(event.target === this) closeModal();">
                    <div style="background: white; border-radius: var(--border-radius); width: 90%; max-width: 600px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease;" onclick="event.stopPropagation();">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, var(--primary-blue), var(--accent-color)); color: white;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-check-circle"></i>
                                <span>Produit scanné</span>
                            </h3>
                            <button type="button" onclick="closeModal()" style="background: rgba(255,255,255,0.2); border: none; font-size: 1.5rem; color: white; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                        <div style="padding: 2rem;">
                            <div style="display: grid; grid-template-columns: 150px 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                                <img src="${product.images[0] || 'https://via.placeholder.com/150'}" style="width: 100%; border-radius: var(--border-radius-sm); object-fit: cover;">
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-bottom: 0.5rem;">${product.category} • ${product.brand}</div>
                                    <h3 style="color: var(--primary-black); margin-bottom: 1rem;">${product.name}</h3>
                                    <div style="font-size: 0.9rem; color: var(--secondary-gray); margin-bottom: 1rem;">
                                        Stock disponible: <span style="font-weight: 700; color: ${product.stock > 0 ? '#28a745' : '#dc3545'};">${product.stock}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Prix unitaire</label>
                                <input type="number" id="scannedProductPrice" class="form-control" value="${product.price}" style="font-size: 1.2rem; font-weight: 700;">
                                <div style="font-size: 0.85rem; color: var(--secondary-gray); margin-top: 0.25rem;">
                                    Vous pouvez modifier le prix avant d'enregistrer la vente
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 1rem;">
                                <label class="form-label">Quantité</label>
                                <input type="number" id="scannedProductQuantity" class="form-control" value="1" min="1" max="${product.stock}">
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: var(--border-radius-sm); margin: 1.5rem 0; text-align: center;">
                                <div style="font-size: 0.9rem; color: var(--secondary-gray); margin-bottom: 0.5rem;">Total</div>
                                <div id="scannedProductTotal" style="font-size: 1.8rem; font-weight: 800; color: var(--primary-blue);">
                                    ${formatPrice(product.price)}
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn" onclick="closeModal()" style="flex: 1; background: #e9ecef;">
                                    Annuler
                                </button>
                                <button class="btn btn-success" onclick="confirmScannedSale(${product.id})" style="flex: 2;">
                                    <i class="fas fa-cash-register"></i> Enregistrer la vente
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Mettre à jour le total en temps réel
            const priceInput = document.getElementById('scannedProductPrice');
            const quantityInput = document.getElementById('scannedProductQuantity');
            const totalDiv = document.getElementById('scannedProductTotal');
            
            const updateTotal = () => {
                const price = parseInt(priceInput.value) || 0;
                const quantity = parseInt(quantityInput.value) || 1;
                totalDiv.textContent = formatPrice(price * quantity);
            };
            
            priceInput.addEventListener('input', updateTotal);
            quantityInput.addEventListener('input', updateTotal);
        }
        
        function confirmScannedSale(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            const price = parseInt(document.getElementById('scannedProductPrice').value) || product.price;
            const quantity = parseInt(document.getElementById('scannedProductQuantity').value) || 1;
            
            if (product.stock < quantity) {
                showToast('Erreur', `Stock insuffisant. Disponible: ${product.stock}`, 'error');
                return;
            }
            
            // Créer la vente avec le prix modifié
            const sale = {
                id: Date.now(),
                productId: product.id,
                productName: product.name,
                quantity: quantity,
                unitPrice: price,
                total: price * quantity,
                date: new Date().toISOString()
            };
            
            if (!state.sales) state.sales = [];
            state.sales.push(sale);
            saveSales();
            
            product.stock -= quantity;
            saveProducts();
            
            closeModal();
            showToast('Succès', `Vente enregistrée: ${quantity}x ${product.name}`, 'success');
            
            if (state.currentPage === 'accounting') {
                setTimeout(() => showPage('accounting'), 500);
            }
        }
        
        function processBarcodeScan() {
            const barcodeInput = document.getElementById('barcodeInput');
            if (barcodeInput && barcodeInput.value) {
                processBarcode(barcodeInput.value.trim());
            }
        }
        
        function selectProductForSale(productId) {
            const product = state.products.find(p => p.id === parseInt(productId));
            const infoDiv = document.getElementById('selectedProductInfo');
            
            if (product && infoDiv) {
                document.getElementById('selectedProductName').textContent = product.name;
                document.getElementById('selectedProductPrice').textContent = formatPrice(product.price);
                document.getElementById('availableStock').textContent = product.stock;
                document.getElementById('saleQuantity').max = product.stock;
                document.getElementById('saleQuantity').value = 1;
                infoDiv.style.display = 'block';
            } else if (infoDiv) {
                infoDiv.style.display = 'none';
            }
        }
        
        function processManualSale() {
            const productId = parseInt(document.getElementById('manualProductSelect').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 1;
            
            if (productId) {
                sellProduct(productId, quantity);
            }
        }
        
        function sellProduct(productId, quantity = 1) {
            const product = state.products.find(p => p.id === productId);
            if (!product) {
                showToast('Erreur', 'Produit introuvable', 'error');
                return;
            }
            
            if (product.stock < quantity) {
                showToast('Erreur', `Stock insuffisant. Disponible: ${product.stock}`, 'error');
                return;
            }
            
            // Créer la vente
            const sale = {
                id: Date.now(),
                productId: product.id,
                productName: product.name,
                quantity: quantity,
                unitPrice: product.price,
                total: product.price * quantity,
                date: new Date().toISOString()
            };
            
            // Ajouter à l'historique des ventes
            if (!state.sales) state.sales = [];
            state.sales.push(sale);
            saveSales();
            
            // Mettre à jour le stock
            product.stock -= quantity;
            saveProducts();
            
            // Réinitialiser les champs
            const manualSelect = document.getElementById('manualProductSelect');
            const barcodeInput = document.getElementById('barcodeInput');
            if (manualSelect) manualSelect.value = '';
            if (barcodeInput) barcodeInput.value = '';
            const infoDiv = document.getElementById('selectedProductInfo');
            if (infoDiv) infoDiv.style.display = 'none';
            
            showToast('Succès', `Vente enregistrée: ${quantity}x ${product.name}`, 'success');
            
            // Recharger la page comptabilité pour mettre à jour les stats
            if (state.currentPage === 'accounting') {
                setTimeout(() => showPage('accounting'), 500);
            }
        }
        
        function filterProductsAccounting(query) {
            const rows = document.querySelectorAll('#accountingProductsTable tr');
            const searchTerm = query.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        function updateCurrency() {
            const selector = document.getElementById('currencySelector');
            if (selector) {
                state.settings.currency = selector.value;
                saveSettings();
                if (state.currentPage === 'accounting') {
                    showPage('accounting');
                }
            }
        }
        
        function showSalesReports() {
            const modalHTML = `
                <div class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;" onclick="if(event.target === this) closeModal();">
                    <div style="background: white; border-radius: var(--border-radius); width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation();">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--primary-blue); margin: 0;">
                                <i class="fas fa-chart-bar"></i> Rapports de ventes
                            </h3>
                            <button type="button" onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; color: var(--secondary-gray); cursor: pointer;">×</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                                <button class="btn btn-primary" onclick="showReportPeriod('week')" style="transition: all 0.3s ease;" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 86, 210, 0.4)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none'">Semaine</button>
                                <button class="btn btn-primary" onclick="showReportPeriod('month')" style="transition: all 0.3s ease;" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 86, 210, 0.4)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none'">Mois</button>
                                <button class="btn btn-primary" onclick="showReportPeriod('year')" style="transition: all 0.3s ease;" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 86, 210, 0.4)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none'">Année</button>
                            </div>
                            <div id="reportContent">
                                ${generateReport('week')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Initialiser les graphiques après un court délai
            setTimeout(() => {
                initSalesCharts('week');
            }, 200);
        }
        
        function showReportPeriod(period) {
            const reportContent = document.getElementById('reportContent');
            if (reportContent) {
                reportContent.innerHTML = generateReport(period);
                
                // Initialiser les graphiques après un court délai
                setTimeout(() => {
                    initSalesCharts(period);
                }, 100);
            }
        }
        
        function initSalesCharts(period) {
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            }
            
            const filteredSales = (state.sales || []).filter(sale => new Date(sale.date) >= startDate);
            const salesByDay = {};
            filteredSales.forEach(sale => {
                const date = new Date(sale.date).toLocaleDateString();
                if (!salesByDay[date]) {
                    salesByDay[date] = { count: 0, revenue: 0 };
                }
                salesByDay[date].count += 1;
                salesByDay[date].revenue += sale.total;
            });
            
            const dates = Object.keys(salesByDay).sort();
            const chartLabels = dates.length > 7 ? dates.slice(-7) : dates;
            const chartData = chartLabels.map(date => salesByDay[date]?.revenue || 0);
            const chartCounts = chartLabels.map(date => salesByDay[date]?.count || 0);
            
            // Graphique des revenus
            const revenueCtx = document.getElementById('salesRevenueChart');
            if (revenueCtx && Chart) {
                new Chart(revenueCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Revenus',
                            data: chartData,
                            borderColor: '#0056D2',
                            backgroundColor: 'rgba(0, 86, 210, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return formatPrice(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Graphique du nombre de ventes
            const countCtx = document.getElementById('salesCountChart');
            if (countCtx && Chart) {
                new Chart(countCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Ventes',
                            data: chartCounts,
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: '#28a745',
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }
        
        function generateReport(period) {
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            }
            
            const filteredSales = (state.sales || []).filter(sale => new Date(sale.date) >= startDate);
            const totalRevenue = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            const totalQuantity = filteredSales.reduce((sum, sale) => sum + sale.quantity, 0);
            
            // Préparer les données pour les graphiques
            const salesByDay = {};
            filteredSales.forEach(sale => {
                const date = new Date(sale.date).toLocaleDateString();
                if (!salesByDay[date]) {
                    salesByDay[date] = { count: 0, revenue: 0 };
                }
                salesByDay[date].count += 1;
                salesByDay[date].revenue += sale.total;
            });
            
            const dates = Object.keys(salesByDay).sort();
            const chartLabels = dates.length > 7 ? dates.slice(-7) : dates;
            const chartData = chartLabels.map(date => salesByDay[date]?.revenue || 0);
            const chartCounts = chartLabels.map(date => salesByDay[date]?.count || 0);
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total ventes</div>
                            <div class="stat-icon"><i class="fas fa-shopping-bag"></i></div>
                        </div>
                        <div class="stat-value">${filteredSales.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Quantité vendue</div>
                            <div class="stat-icon"><i class="fas fa-box"></i></div>
                        </div>
                        <div class="stat-value">${totalQuantity}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Revenus totaux</div>
                            <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
                        </div>
                        <div class="stat-value">${formatPrice(totalRevenue)}</div>
                    </div>
                </div>
                
                ${filteredSales.length > 0 ? `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-blue);">Revenus par jour</h4>
                            <canvas id="salesRevenueChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-blue);">Nombre de ventes par jour</h4>
                            <canvas id="salesCountChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                ` : ''}
                
                <div class="table-content" style="margin-top: 2rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Produit</th>
                                <th>Quantité</th>
                                <th>Prix unitaire</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredSales.length > 0 ? filteredSales.slice().reverse().map(sale => `
                                <tr>
                                    <td>${new Date(sale.date).toLocaleString()}</td>
                                    <td>${sale.productName}</td>
                                    <td>${sale.quantity}</td>
                                    <td>${formatPrice(sale.unitPrice)}</td>
                                    <td style="font-weight: 800; color: var(--primary-blue);">${formatPrice(sale.total)}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="5" style="text-align: center; padding: 2rem;">Aucune vente</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function saveSales() {
            localStorage.setItem('targui_sales', JSON.stringify(state.sales));
        }
        
        // Exposer les fonctions globalement
        window.initBarcodeScanner = initBarcodeScanner;
        window.processBarcodeScan = processBarcodeScan;
        window.selectProductForSale = selectProductForSale;
        window.processManualSale = processManualSale;
        window.sellProduct = sellProduct;
        window.filterProductsAccounting = filterProductsAccounting;
        window.updateCurrency = updateCurrency;
        window.showSalesReports = showSalesReports;
        window.showReportPeriod = showReportPeriod;
        window.confirmScannedSale = confirmScannedSale;
        window.filterByFavorites = filterByFavorites;
        window.orderViaWhatsApp = orderViaWhatsApp;
        window.showStoreLocation = showStoreLocation;
        window.updateLogoPreview = updateLogoPreview;
        window.navigateProductMedia = navigateProductMedia;
        window.goToProductMedia = goToProductMedia;
        window.showLogoAnimation = showLogoAnimation;
        window.closeLogoAnimation = closeLogoAnimation;
        window.toggleSidebar = toggleSidebar;
        window.openSidebarOnHover = openSidebarOnHover;
        window.showAddProductFromScanModal = showAddProductFromScanModal;
        window.addProductFromScan = addProductFromScan;
        window.showAddProductByScanModal = showAddProductByScanModal;
        window.processAddProductScan = processAddProductScan;
        window.detectBarcodeScanners = detectBarcodeScanners;
        window.requestUSBAccess = requestUSBAccess;
        
        console.log('🚀 Dashboard Admin - TARGUI STORE');
        console.log('📊 Version: 4.0 Premium');
        console.log('🎨 Design: Professionnel');
        console.log('👑 Bienvenue Administrateur!');
    </script>
</body>
</html>